
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D25 Â· State of the District</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Lora:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #0b0d13;
  --bg2:    #10131c;
  --card:   #161b27;
  --card2:  #1c2233;
  --border: rgba(255,255,255,0.07);
  --b2:     rgba(255,255,255,0.13);
  --text:   #e8eaf2;
  --text2:  #8f98b3;
  --text3:  #4e5670;
  --p1: #34d4b0;
  --p2: #f59e0b;
  --p3: #4f8ef7;
  --p4: #a78bfa;
  --p5: #fb923c;
  --ca: #fb7185;
  --green:  #4ade80;
  --rose:   #fb7185;
  --amber:  #f59e0b;
  --blue:   #4f8ef7;
  --purple: #a78bfa;
  --teal:   #34d4b0;
  --orange: #fb923c;
  --ff-h: 'Syne', sans-serif;
  --ff-b: 'Lora', serif;
  --ff-m: 'IBM Plex Mono', monospace;
  --r: 14px; --r2: 20px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--ff-b);min-height:100vh;overflow-x:hidden;}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 80% 50% at 10% 0%,rgba(52,212,176,.06) 0%,transparent 55%),
    radial-gradient(ellipse 60% 40% at 90% 100%,rgba(79,142,247,.05) 0%,transparent 55%),
    radial-gradient(ellipse 50% 50% at 50% 50%,rgba(167,139,250,.03) 0%,transparent 60%);
}

/* â”€â”€ LOADER â”€â”€ */
#loader{
  position:fixed;inset:0;z-index:200;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;
  transition:opacity .5s ease, visibility .5s ease;
}
#loader.done{opacity:0;visibility:hidden;pointer-events:none;}
.ld-logo{font-family:var(--ff-h);font-size:1.4rem;font-weight:800;color:var(--text2);}
.ld-bar-bg{width:260px;height:3px;background:rgba(255,255,255,.08);border-radius:100px;overflow:hidden;}
.ld-bar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--teal),var(--blue));border-radius:100px;transition:width .4s ease;}
.ld-status{font-family:var(--ff-m);font-size:.7rem;color:var(--text3);}
.ld-steps{display:flex;gap:1.5rem;}
.ld-step{display:flex;align-items:center;gap:.4rem;font-family:var(--ff-m);font-size:.65rem;color:var(--text3);transition:color .3s;}
.ld-step.done{color:var(--teal);}
.ld-step.active{color:var(--text);}
.ld-step-dot{width:6px;height:6px;border-radius:50%;background:currentColor;}

/* â”€â”€ NAV â”€â”€ */
nav{position:sticky;top:0;z-index:100;background:rgba(11,13,19,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.nav-inner{max-width:1440px;margin:0 auto;padding:0 2rem;display:flex;align-items:center;height:54px;gap:1.5rem;}
.nav-brand{font-family:var(--ff-h);font-size:.9rem;font-weight:800;color:var(--text);white-space:nowrap;display:flex;align-items:center;gap:.5rem;}
.nav-pulse{width:7px;height:7px;border-radius:50%;background:var(--teal);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
.nav-links{display:flex;gap:.1rem;overflow-x:auto;flex:1;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:.1rem 0;}
.nav-link{display:flex;align-items:center;gap:.3rem;padding:.3rem .7rem;border-radius:8px;border:none;background:transparent;color:var(--text2);font-family:var(--ff-m);font-size:.64rem;letter-spacing:.03em;cursor:pointer;transition:all .18s;white-space:nowrap;position:relative;}
/* Tooltip on hover â€” shows full priority name */
.nav-link::after{content:attr(title);position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);background:rgba(16,20,32,.97);color:var(--text);font-size:.6rem;white-space:nowrap;padding:.35rem .65rem;border-radius:7px;border:1px solid var(--border);pointer-events:none;opacity:0;transition:opacity .18s;z-index:200;max-width:260px;white-space:normal;text-align:center;line-height:1.4;}
.nav-link:hover::after{opacity:1;}
.nav-link .nl-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.nav-link:hover,.nav-link.active{background:rgba(255,255,255,.06);color:var(--text);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:.75rem;flex-shrink:0;}
.live-badge{display:flex;align-items:center;gap:.4rem;font-family:var(--ff-m);font-size:.65rem;color:var(--teal);padding:.25rem .7rem;background:rgba(52,212,176,.08);border:1px solid rgba(52,212,176,.2);border-radius:100px;}
#last-updated{font-family:var(--ff-m);font-size:.62rem;color:var(--text3);}

/* â”€â”€ PAGE â”€â”€ */
#app{position:relative;z-index:1;opacity:0;transition:opacity .5s ease;}
#app.visible{opacity:1;}
.page{max-width:1440px;margin:0 auto;padding:0 2rem 5rem;}

/* â”€â”€ HERO â”€â”€ */
.hero{padding:3.5rem 0 2.5rem;border-bottom:1px solid var(--border);margin-bottom:3rem;scroll-margin-top:64px;}
.hero-top{display:grid;grid-template-columns:1fr 1fr;gap:3rem;align-items:end;margin-bottom:2.5rem;}
@media(max-width:900px){.hero-top{grid-template-columns:1fr;}}
.hero-eye{font-family:var(--ff-m);font-size:.68rem;color:var(--teal);letter-spacing:.2em;text-transform:uppercase;display:flex;align-items:center;gap:.6rem;margin-bottom:.9rem;}
.hero-eye::before{content:'';width:18px;height:1.5px;background:var(--teal);}
h1{font-family:var(--ff-h);font-size:clamp(2.8rem,5.5vw,5.2rem);font-weight:800;line-height:.92;letter-spacing:-.02em;}
h1 .acc{color:var(--teal);}
.hero-desc{margin-top:1.1rem;font-size:.9rem;color:var(--text2);line-height:1.75;max-width:480px;}
.hero-kpis{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;}
.hkpi{background:var(--card);padding:1.4rem 1.6rem;}
.hkpi-label{font-family:var(--ff-m);font-size:.62rem;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.4rem;}
.hkpi-val{font-family:var(--ff-h);font-size:1.9rem;font-weight:700;line-height:1;margin-bottom:.25rem;}
.hkpi-sub{font-size:.72rem;color:var(--text2);}

/* â”€â”€ CEP PRIORITY CARDS â”€â”€ */
.cep-section{margin-bottom:3rem;}
.cep-heading{font-family:var(--ff-h);font-size:1rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:var(--text2);margin-bottom:1.25rem;display:flex;align-items:center;gap:.75rem;}
.cep-heading::after{content:'';flex:1;height:1px;background:var(--border);}
.cep-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem;}
@media(max-width:1100px){.cep-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:700px){.cep-grid{grid-template-columns:1fr;}}
.cep-card{border-radius:var(--r2);overflow:hidden;border:1px solid var(--border);background:var(--card);transition:border-color .2s,transform .2s,box-shadow .2s;cursor:pointer;}
.cep-card:hover{border-color:var(--cc,var(--teal));transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.35);}
.cep-top{padding:1.25rem 1.4rem 1rem;border-bottom:1px solid var(--border);border-top:3px solid var(--cc,var(--teal));}
.cep-num{font-family:var(--ff-m);font-size:.62rem;letter-spacing:.14em;text-transform:uppercase;color:var(--cc,var(--teal));margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem;}
.cep-title{font-family:var(--ff-h);font-size:1rem;font-weight:700;line-height:1.2;color:var(--text);}
.cep-body{padding:1rem 1.4rem 1.25rem;}
.cep-goal{font-size:.78rem;color:var(--text2);line-height:1.6;margin-bottom:.85rem;}
.cep-metrics{display:flex;flex-wrap:wrap;gap:.4rem;}
.cep-metric{display:flex;align-items:center;gap:.3rem;font-family:var(--ff-m);font-size:.63rem;padding:.22rem .6rem;border-radius:6px;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--text2);}
.cep-metric .dot{width:5px;height:5px;border-radius:50%;}

/* â”€â”€ TARGET TRACKER â”€â”€ */
.target-row{display:grid;grid-template-columns:repeat(5,1fr);gap:.85rem;margin-bottom:3rem;}
@media(max-width:1200px){.target-row{grid-template-columns:repeat(3,1fr);}} @media(max-width:800px){.target-row{grid-template-columns:repeat(2,1fr);}} @media(max-width:500px){.target-row{grid-template-columns:1fr;}}
@media(max-width:600px){.target-row{grid-template-columns:1fr;}}
.target-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:1.4rem;border-top:2px solid var(--tc,var(--teal));transition:transform .15s,box-shadow .15s;cursor:zoom-in;}
.tc-label{font-family:var(--ff-m);font-size:.62rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.7rem;}
.tc-current{font-family:var(--ff-h);font-size:1.4rem;font-weight:700;color:var(--text);line-height:1;margin-bottom:.3rem;}
.target-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.35);}
.tc-target-txt{font-size:.72rem;color:var(--text2);}
.tc-bar-wrap{display:flex;align-items:center;gap:.75rem;margin-top:.75rem;margin-bottom:.5rem;}
.tc-bar-bg{flex:1;height:8px;background:rgba(255,255,255,.08);border-radius:100px;overflow:hidden;}
.tc-bar-fill{height:100%;width:0%;border-radius:100px;background:var(--tc,var(--teal));transition:width 1.4s cubic-bezier(.4,0,.2,1);}
.tc-pct{font-family:var(--ff-m);font-size:.75rem;color:var(--text);width:35px;text-align:right;flex-shrink:0;}
.tc-vals{display:flex;justify-content:space-between;font-family:var(--ff-m);font-size:.67rem;color:var(--text3);}
.tc-note{font-family:var(--ff-m);font-size:.6rem;color:var(--text3);margin-top:.4rem;}

/* â”€â”€ SECTION â”€â”€ */
.section{margin-bottom:4rem;scroll-margin-top:64px;}
.sec-head{display:flex;align-items:center;gap:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border);margin-bottom:1.75rem;}
.sec-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.sec-titles{flex:1;}
.sec-title{font-family:var(--ff-h);font-size:1.4rem;font-weight:700;}
.sec-sub{font-family:var(--ff-m);font-size:.67rem;color:var(--text3);margin-top:.2rem;}
.sec-badge{font-family:var(--ff-m);font-size:.63rem;padding:.22rem .65rem;border-radius:6px;font-weight:500;white-space:nowrap;}

/* â”€â”€ GOAL BANNER â”€â”€ */
.goal-banner{background:linear-gradient(135deg,rgba(52,212,176,.07),rgba(79,142,247,.05));border:1px solid rgba(52,212,176,.15);border-radius:var(--r2);padding:1.25rem 1.5rem;margin-bottom:1.5rem;display:flex;align-items:flex-start;gap:1rem;flex-wrap:wrap;}
.gb-icon{font-size:1.4rem;flex-shrink:0;}
.gb-text{flex:1;}
.gb-label{font-family:var(--ff-m);font-size:.62rem;color:var(--teal);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.3rem;}
.gb-goal{font-size:.82rem;color:var(--text);line-height:1.6;}
.gb-target{font-family:var(--ff-m);font-size:.68rem;padding:.25rem .7rem;border-radius:6px;background:rgba(52,212,176,.1);color:var(--teal);border:1px solid rgba(52,212,176,.2);white-space:nowrap;flex-shrink:0;align-self:flex-start;}

/* â”€â”€ FILTER â”€â”€ */
.filter-strip{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:1.4rem;align-items:center;}
.fl{font-family:var(--ff-m);font-size:.65rem;color:var(--text3);margin-right:.25rem;}
.fb{padding:.28rem .85rem;border-radius:100px;border:1px solid var(--border);background:transparent;color:var(--text2);font-family:var(--ff-m);font-size:.68rem;cursor:pointer;transition:all .17s;}
.fb:hover{border-color:var(--text2);color:var(--text);}
.fb.active{background:rgba(255,255,255,.1);border-color:var(--b2);color:var(--text);}
/* Window filter buttons */
.win-filter-strip{display:flex;gap:.35rem;margin-bottom:.75rem;align-items:center;}
.wfl{font-family:var(--ff-m);font-size:.62rem;color:var(--text3);margin-right:.2rem;}
.wfb{padding:.22rem .7rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-family:var(--ff-m);font-size:.65rem;cursor:pointer;transition:all .17s;}
.wfb:hover{border-color:var(--text2);color:var(--text);}
.wfb.active{background:rgba(255,255,255,.12);border-color:var(--b2);color:var(--text);font-weight:700;}
/* Brighter small subtitles */
.cs{font-family:var(--ff-m);font-size:.68rem;color:var(--text2) !important;margin-top:.2rem;}

/* â”€â”€ GRIDS â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.g21{display:grid;grid-template-columns:2fr 1fr;gap:1rem;}
@media(max-width:1000px){.g2,.g21{grid-template-columns:1fr;}}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:1.5rem;transition:border-color .2s,box-shadow .2s;}
.card:hover{border-color:var(--b2);box-shadow:0 8px 30px rgba(0,0,0,.25);}
.ch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem;gap:.75rem;}
.ct{font-family:var(--ff-h);font-size:1.05rem;font-weight:700;line-height:1.2;}
.cs{font-family:var(--ff-m);font-size:.64rem;color:var(--text3);margin-top:.2rem;}
.tag{font-family:var(--ff-m);font-size:.62rem;padding:.2rem .55rem;border-radius:5px;font-weight:500;white-space:nowrap;flex-shrink:0;}
.tg{background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.2);}
.tb{background:rgba(79,142,247,.1);color:var(--blue);border:1px solid rgba(79,142,247,.2);}
.ta{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.tr{background:rgba(251,113,133,.1);color:var(--rose);border:1px solid rgba(251,113,133,.2);}
.tp{background:rgba(167,139,250,.1);color:var(--purple);border:1px solid rgba(167,139,250,.2);}
.tt{background:rgba(52,212,176,.1);color:var(--teal);border:1px solid rgba(52,212,176,.2);}
.cw{position:relative;}
.h200{height:200px;}.h240{height:240px;}.h280{height:280px;}.h300{height:300px;}.h320{height:320px;}
.sl{display:flex;gap:.85rem;flex-wrap:wrap;margin-bottom:.9rem;}
.si{display:flex;align-items:center;gap:.35rem;font-size:.72rem;color:var(--text2);}
.sd{width:9px;height:9px;border-radius:2px;flex-shrink:0;}

/* â”€â”€ INSIGHT CARDS â”€â”€ */
.ins-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.25rem;}
@media(max-width:900px){.ins-row{grid-template-columns:1fr;}}
.ins{background:var(--card2);border:1px solid var(--border);border-radius:var(--r2);padding:1.2rem 1.4rem;border-left:3px solid var(--ic,var(--teal));}
.il{font-family:var(--ff-m);font-size:.62rem;text-transform:uppercase;letter-spacing:.12em;color:var(--text3);margin-bottom:.35rem;}
.iv{font-family:var(--ff-h);font-size:2.1rem;font-weight:700;color:var(--ic,var(--teal));line-height:1;margin-bottom:.25rem;}
.id{font-size:.78rem;color:var(--text2);line-height:1.5;}

/* â”€â”€ TABLE â”€â”€ */
.dt{width:100%;border-collapse:collapse;font-size:.79rem;}
.dt th{font-family:var(--ff-m);font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:.5rem .7rem;border-bottom:1px solid var(--border);text-align:left;font-weight:500;}
.dt td{padding:.6rem .7rem;border-bottom:1px solid rgba(255,255,255,.04);}
.dt tr:last-child td{border-bottom:none;}
.dt tr:hover td{background:rgba(255,255,255,.02);}
.dn{font-family:var(--ff-b);font-weight:600;}
.dm{font-family:var(--ff-m);font-size:.75rem;}
.dp{display:inline-block;padding:.14rem .5rem;border-radius:100px;font-family:var(--ff-m);font-size:.65rem;font-weight:500;}
.pg{background:rgba(74,222,128,.1);color:var(--green);}
.pa{background:rgba(245,158,11,.1);color:var(--amber);}
.pr{background:rgba(251,113,133,.1);color:var(--rose);}
.pb{background:rgba(79,142,247,.1);color:var(--blue);}

/* â”€â”€ CA YEAR CARDS â”€â”€ */
.ca-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:.75rem;margin-bottom:1.5rem;}
@media(max-width:1000px){.ca-grid{grid-template-columns:repeat(3,1fr);}}
.cac{background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:1rem;text-align:center;transition:all .2s;}
.cac:hover{border-color:var(--b2);transform:translateY(-2px);}
.cac-yr{font-family:var(--ff-m);font-size:.6rem;color:var(--text3);margin-bottom:.3rem;}
.cac-val{font-family:var(--ff-h);font-size:1.45rem;font-weight:700;}
.cac-tr{font-family:var(--ff-m);font-size:.67rem;margin-top:.2rem;}

/* â”€â”€ COMING SOON â”€â”€ */
.coming-soon{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r2);
  padding:4rem 2rem;text-align:center;
}
.cs-icon{font-size:3rem;margin-bottom:1rem;}
.cs-title{font-family:var(--ff-h);font-size:1.5rem;font-weight:700;margin-bottom:.75rem;color:var(--text2);}
.cs-desc{font-size:.85rem;color:var(--text3);max-width:400px;margin:0 auto;line-height:1.7;}
.cs-tag{display:inline-block;margin-top:1rem;font-family:var(--ff-m);font-size:.68rem;padding:.3rem .8rem;border-radius:6px;background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2);}

/* â”€â”€ ERROR STATE â”€â”€ */
.fetch-error{background:rgba(251,113,133,.06);border:1px solid rgba(251,113,133,.2);border-radius:var(--r2);padding:1.5rem;margin-bottom:1rem;font-family:var(--ff-m);font-size:.75rem;color:var(--rose);}

/* â”€â”€ FOOTER â”€â”€ */
footer{position:relative;z-index:1;border-top:1px solid var(--border);padding:1.75rem 2rem;max-width:1440px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;}
.ft{font-family:var(--ff-m);font-size:.66rem;color:var(--text3);}
.fb2{display:flex;gap:.6rem;}
.btn{padding:.48rem 1.2rem;border-radius:8px;font-family:var(--ff-b);font-size:.8rem;font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.btn-p{background:var(--blue);color:#fff;}.btn-p:hover{background:#3a7ae8;}
.btn-g{background:transparent;border:1px solid var(--b2);color:var(--text2);}.btn-g:hover{border-color:var(--teal);color:var(--teal);}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:fadeUp .5s ease both;}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE RESPONSIVE â€” full phone support
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Base mobile (â‰¤640px) â”€â”€ */
@media(max-width:640px){
  /* Page padding */
  .page{ padding:0 .9rem 4rem; }

  /* Nav â€” collapse links, shrink brand */
  .nav-inner{ padding:0 .9rem; gap:.6rem; height:48px; }
  .nav-brand{ font-size:.75rem; }
  .nav-links{ display:none; }          /* hide text links on phone */
  #last-updated{ display:none; }
  .live-badge{ font-size:.58rem; padding:.2rem .5rem; }

  /* Hero */
  .hero{ padding:1.8rem 0 1.4rem; margin-bottom:1.6rem; }
  .hero-top{ grid-template-columns:1fr; gap:1.4rem; }
  h1{ font-size:clamp(2rem,9vw,3rem); }
  .hero-desc{ font-size:.82rem; max-width:100%; }
  .hero-kpis{ grid-template-columns:1fr 1fr; }
  .hkpi{ padding:1rem 1.1rem; }
  .hkpi-val{ font-size:1.5rem; }

  /* Section headers */
  .sec-head{ flex-wrap:wrap; gap:.6rem; }
  .sec-badge{ display:none; }

  /* Chart grids â€” all single column */
  .g2,.g21,.g3{ grid-template-columns:1fr !important; }

  /* Chart heights â€” shorter on phone */
  .h400{ height:260px; }
  .h320{ height:240px; }
  .h280{ height:220px; }
  .h260{ height:200px; }
  .h240{ height:190px; }
  .h200{ height:170px; }
  .h300{ height:220px; }

  /* Chart canvas text â€” scale down */
  .cw canvas{ font-size:9px; }

  /* Filter strips â€” wrap & smaller buttons */
  .filter-strip,.win-filter-strip{ gap:.25rem; flex-wrap:wrap; }
  .fb,.wfb{ font-size:.6rem; padding:.18rem .55rem; }
  .wfl{ font-size:.58rem; }

  /* Cards */
  .card{ border-radius:10px; }
  .ch{ flex-wrap:wrap; gap:.4rem; }
  .ct{ font-size:.85rem; }
  .cs{ font-size:.6rem; }

  /* Insight cards â€” single column */
  .ins-row{ grid-template-columns:1fr !important; }
  .ins{ padding:.9rem 1rem; }
  .iv{ font-size:1.4rem; }

  /* Tables â€” horizontal scroll + compact */
  .dt{ font-size:.68rem; }
  .dt th,.dt td{ padding:.35rem .45rem; white-space:nowrap; }
  [style*="overflow-x:auto"]{ -webkit-overflow-scrolling:touch; }

  /* KPI stats */
  .sl{ gap:.5rem; }
  .sl-item{ padding:.65rem .9rem; }
  .sl-val{ font-size:1.1rem; }

  /* CEP cards */
  .cep-grid{ grid-template-columns:1fr !important; }

  /* Goal tracker â€” single column */
  .target-row{ grid-template-columns:1fr !important; }
  .target-card{ padding:.9rem 1rem; }
  .tc-current{ font-size:1.2rem; }

  /* CA cards */
  .ca-grid{ grid-template-columns:1fr 1fr !important; }
  .cac{ padding:.8rem .9rem; }
  .cac-val{ font-size:1.3rem; }

  /* Window filter â€” wrap to 2 rows if needed */
  .win-filter-strip{ margin-bottom:.6rem; }

  /* Section padding */
  .section{ margin-bottom:2.5rem; }
  .sec-head{ margin-bottom:1.2rem; }

  /* Hero KPI grid â€” 2 cols on phone */
  .hero-kpis{ grid-template-columns:1fr 1fr; }

  /* Footer */
  footer .ft{ font-size:.65rem; padding:.8rem 1rem; }
  footer .fb2{ padding:.6rem 1rem; gap:.5rem; }
  .btn{ font-size:.7rem; padding:.4rem .8rem; }
}

/* â”€â”€ Tablet (641â€“900px) â”€â”€ */
@media(min-width:641px) and (max-width:900px){
  .page{ padding:0 1.25rem 4rem; }
  .nav-links{ gap:.05rem; }
  .nav-link{ font-size:.6rem; padding:.28rem .6rem; }
  .g2,.g21{ grid-template-columns:1fr !important; }
  .h400{ height:300px; }
  .h320{ height:260px; }
  .target-row{ grid-template-columns:repeat(3,1fr) !important; }
  .ins-row{ grid-template-columns:1fr 1fr !important; }
  .hero-kpis{ grid-template-columns:1fr 1fr; }
}

/* â”€â”€ Touch devices â€” improve tap targets â”€â”€ */
@media(hover:none) and (pointer:coarse){
  .fb,.wfb,.nav-link,.btn{ min-height:36px; display:inline-flex; align-items:center; }
  .dt th,.dt td{ padding:.45rem .55rem; }
}

@media print{nav{display:none;}body{background:#fff;color:#000;}}
</style>
</head>
<body>

<!-- â”€â”€ LOADER â”€â”€ -->
<div id="loader">
  <div class="ld-logo">State of the District Â· Loading</div>
  <div class="ld-bar-bg"><div class="ld-bar-fill" id="ldBar"></div></div>
  <div class="ld-steps">
    <div class="ld-step" id="ls-acad"><span class="ld-step-dot"></span>Acadience</div>
    <div class="ld-step" id="ls-read"><span class="ld-step-dot"></span>iReady Reading</div>
    <div class="ld-step" id="ls-math"><span class="ld-step-dot"></span>iReady Math</div>
    <div class="ld-step" id="ls-ca"><span class="ld-step-dot"></span>Absenteeism</div>
    <div class="ld-step" id="ls-sel"><span class="ld-step-dot"></span>SEL</div>
  </div>
  <div class="ld-status" id="ldStatus">Connecting to Google Sheetsâ€¦</div>
</div>

<!-- â”€â”€ NAV â”€â”€ -->
<nav>
  <div class="nav-inner">
    <div class="nav-brand"><span class="nav-pulse"></span>D25 Â· State of the District</div>
    <div class="nav-links" id="navLinks">
      <button class="nav-link active" data-section="cep" onclick="navTo('cep',this)" title="CEP Goals &amp; Progress Monitoring">
        <span class="nl-dot" style="background:var(--teal)"></span>CEP Goals
      </button>
      <button class="nav-link" data-section="cep-progress" onclick="navTo('cep-progress',this)" title="Progress Monitoring Dashboard">
        <span class="nl-dot" style="background:var(--purple)"></span>Progress
      </button>
      <button class="nav-link" data-section="p1" onclick="navTo('p1',this)" title="Priority 1 Â· All Students Learn to Read Well">
        <span class="nl-dot" style="background:var(--p1)"></span>P1 Â· Reading
      </button>
      <button class="nav-link" data-section="p2" onclick="navTo('p2',this)" title="Priority 2 Â· All Students Are Physically and Emotionally Safe">
        <span class="nl-dot" style="background:var(--p2)"></span>P2 Â· SEL
      </button>
      <button class="nav-link" data-section="p3" onclick="navTo('p3',this)" title="Priority 3 Â· All Students Receive a High Quality Academic Experience">
        <span class="nl-dot" style="background:var(--p3)"></span>P3 Â· Math
      </button>
      <button class="nav-link" data-section="p4" onclick="navTo('p4',this)" title="Priority 4 Â· All Students Graduate College &amp; Career Ready">
        <span class="nl-dot" style="background:var(--p4)"></span>P4 Â· Graduation
      </button>
      <button class="nav-link" data-section="p5" onclick="navTo('p5',this)" title="Priority 5 Â· All Districts &amp; Schools Are More Inclusive for Families">
        <span class="nl-dot" style="background:var(--p5)"></span>P5 Â· Families
      </button>
      <button class="nav-link" data-section="ca-section" onclick="navTo('ca-section',this)" title="Chronic Absenteeism">
        <span class="nl-dot" style="background:var(--ca)"></span>Absenteeism
      </button>
    </div>
    <div class="nav-right">
      <div id="last-updated"></div>
      <div class="live-badge"><span class="nav-pulse" style="background:var(--teal)"></span>Live</div>
    </div>
  </div>
</nav>

<div id="app">
<div class="page">

<!-- â”€â”€ HERO â”€â”€ -->
<div class="hero anim d1">
  <div class="hero-top">
    <div>
      <div class="hero-eye">D25 Â· 2025â€“26 Comprehensive Education Plan</div>
      <h1>STATE OF<br>THE <span class="acc">DISTRICT</span></h1>
      <p class="hero-desc">Progress toward our five strategic priorities â€” measured by Acadience (Kâ€“2), iReady Reading &amp; Mathematics (3â€“8), chronic absenteeism data, and SEL outcomes. Reported three times per year: BOY Â· MOY Â· EOY.</p>
    </div>
    <div class="hero-kpis">
      <div class="hkpi">
        <div class="hkpi-label">Report Window</div>
        <div class="hkpi-val" style="color:var(--teal)" id="hkpi-window">MOY 25-26</div>
        <div class="hkpi-sub">Middle of Year</div>
      </div>
      <div class="hkpi">
        <div class="hkpi-label">Acadience On/Above (All)</div>
        <div class="hkpi-val" style="color:var(--p1)" id="hkpi-acad">â€”</div>
        <div class="hkpi-sub">Kâ€“2 Â· All Students</div>
      </div>
      <div class="hkpi">
        <div class="hkpi-label">iReady Reading â‰¥ GL (All)</div>
        <div class="hkpi-val" style="color:var(--p3)" id="hkpi-read">â€”</div>
        <div class="hkpi-sub">Gr 3â€“8 Â· All Students</div>
      </div>
      <div class="hkpi">
        <div class="hkpi-label">Chronic Absence (Latest)</div>
        <div class="hkpi-val" style="color:var(--ca)" id="hkpi-ca">â€”</div>
        <div class="hkpi-sub">Most recent YTD month</div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ CEP PRIORITIES â”€â”€ -->
<section class="cep-section anim d2" id="cep" style="scroll-margin-top:64px">
  <div id="cep-goals" style="scroll-margin-top:64px"></div>
  <div class="cep-heading">2025â€“26 CEP Â· Five Strategic Priorities</div>
  <p style="font-family:var(--ff-b);font-size:.85rem;color:var(--text2);max-width:860px;line-height:1.75;margin-bottom:1.5rem">
    District 25's Comprehensive Education Plan is organized around five interconnected priorities.
    Click any priority card to jump to its live data dashboard. The tracker below monitors progress
    toward measurable annual goals for each priority.
  </p>
  <div class="cep-grid">
    <div class="cep-card" style="--cc:var(--p1)" onclick="navTo('p1',null)">
      <div class="cep-top"><div class="cep-num">â— Priority 1</div><div class="cep-title">All Students Learn to Read Well</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: <strong>+5% All Students</strong> and <strong>+10% Hispanic, Black, SWD</strong> meeting/exceeding grade level in Kâ€“8. <strong>+10% ELL</strong> advancing 1 NYSESLAT proficiency level.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--p1)"></span>Acadience Kâ€“2</span><span class="cep-metric"><span class="dot" style="background:var(--p1)"></span>iReady Reading 3â€“8</span><span class="cep-metric"><span class="dot" style="background:var(--p1)"></span>NYS Assessments</span></div>
      </div>
    </div>
    <div class="cep-card" style="--cc:var(--p2)" onclick="navTo('p2',null)">
      <div class="cep-top"><div class="cep-num">â— Priority 2</div><div class="cep-title">All Students Are Physically and Emotionally Safe</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: <strong>+10% increase</strong> in student-to-student relationships and students reporting MindUP curriculum helps manage emotions, stay focused, and make better choices.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--p2)"></span>District Student Survey</span><span class="cep-metric"><span class="dot" style="background:var(--p2)"></span>MindUP Moments</span></div>
      </div>
    </div>
    <div class="cep-card" style="--cc:var(--p3)" onclick="navTo('p3',null)">
      <div class="cep-top"><div class="cep-num">â— Priority 3</div><div class="cep-title">All Students Are Mathematically Proficient</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: <strong>+5% All Students</strong> and <strong>+10% Hispanic, Black, SWD, ELL</strong> meeting or exceeding grade level in mathematics.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--p3)"></span>iReady Mathematics 3â€“8</span><span class="cep-metric"><span class="dot" style="background:var(--p3)"></span>NYS Assessments</span></div>
      </div>
    </div>
  </div>
  <div class="cep-grid" style="margin-top:1rem">
    <div class="cep-card" style="--cc:var(--p4);cursor:pointer" onclick="navTo('p4',null)">
      <div class="cep-top"><div class="cep-num">â— Priority 4</div><div class="cep-title">College, Career Ready &amp; Economic Security</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: All learners in <strong>Project Soapbox</strong> + one Take Action Project. 8th graders earn 1 pt toward <strong>Seal for Civic Readiness</strong>. <strong>+10%</strong> Save for College activated accounts.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--p4)"></span>Project Soapbox</span><span class="cep-metric"><span class="dot" style="background:var(--p4)"></span>Civic Readiness Seal</span><span class="cep-metric"><span class="dot" style="background:var(--p4)"></span>Save for College</span></div>
      </div>
    </div>
    <div class="cep-card" style="--cc:var(--p5);cursor:pointer" onclick="navTo('p5',null)">
      <div class="cep-top"><div class="cep-num">â— Priority 5</div><div class="cep-title">Inclusive &amp; Responsive for Families</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: Monthly/quarterly family engagement events. <strong>+5% positive responses</strong> on NYC School Survey related to family engagement and communication.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--p5)"></span>NYC School Survey</span><span class="cep-metric"><span class="dot" style="background:var(--p5)"></span>Family Events</span></div>
      </div>
    </div>
    <div class="cep-card" style="--cc:var(--ca)" onclick="navTo('ca-section',null)">
      <div class="cep-top"><div class="cep-num">â— Chronic Absenteeism</div><div class="cep-title">Reduce Chronic Absence for All Subgroups</div></div>
      <div class="cep-body">
        <div class="cep-goal">By June 2026: CASE teams monitor CA data providing support resulting in a <strong>4% reduction</strong> in CA rates for ELL, SWD, Hispanic and Black learners.</div>
        <div class="cep-metrics"><span class="cep-metric"><span class="dot" style="background:var(--ca)"></span>YTD CA Rate</span><span class="cep-metric"><span class="dot" style="background:var(--ca)"></span>Subgroup Breakdown</span></div>
      </div>
    </div>
  </div>
</section>

<!-- â”€â”€ GOAL TRACKER â”€â”€ -->
<div class="anim d3" style="margin-bottom:3rem;">
  <div id="cep-progress" style="scroll-margin-top:64px"></div>
  <div class="cep-heading">Goal Progress Tracker â€” All Subgroups Â· Baseline: EOY 24-25 â†’ MOY Checkpoint â†’ EOY Target</div>
  <div class="target-row" id="targetRow"></div>
</div>

<!-- â•â•â•â•â•â•â•â• P1 ACADIENCE â•â•â•â•â•â•â•â• -->
<section class="section" id="p1">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(52,212,176,.1)">ğŸ“š</div>
    <div class="sec-titles"><div class="sec-title" style="color:var(--p1)">Priority 1 Â· Acadience Reading Kâ€“2</div><div class="sec-sub">All Students Learn to Read Well Â· Live from Google Sheets Â· 2023â€“24 through 2025â€“26</div></div>
    <span class="sec-badge tt">Kâ€“2 Â· 5 Subgroups</span>
  </div>
  <div class="goal-banner">
    <div class="gb-icon">ğŸ¯</div>
    <div class="gb-text"><div class="gb-label">Priority 1 Goal</div><div class="gb-goal">By June 2026: <strong>+5% increase</strong> for All Students and <strong>+10% increase</strong> for Hispanic, Black, and SWD learners meeting or exceeding grade-level standards (Acadience On/Above Benchmark).</div></div>
    <div class="gb-target">Target: June 2026</div>
  </div>
  <div class="ins-row anim d1" id="acadInsights"></div>
  <div class="win-filter-strip" id="acadWinFilter">
    <span class="wfl">Window:</span>
    <button class="wfb active" onclick="setWinFilter('acad','ALL',this)">All Years</button>
    <button class="wfb" onclick="setWinFilter('acad','BOY',this)">BOY Only</button>
    <button class="wfb" onclick="setWinFilter('acad','MOY',this)">MOY Only</button>
    <button class="wfb" onclick="setWinFilter('acad','EOY',this)">EOY Only</button>
  </div>
  <div class="filter-strip" id="acadFilter">
    <span class="fl">Subgroup:</span>
    <button class="fb active" onclick="setGroup('acad','All Students',this)">All Students</button>
    <button class="fb" onclick="setGroup('acad','Hispanics',this)">Hispanic</button>
    <button class="fb" onclick="setGroup('acad','Black',this)">Black</button>
    <button class="fb" onclick="setGroup('acad','ELL',this)">ELL</button>
    <button class="fb" onclick="setGroup('acad','SWD',this)">SWD</button>
  </div>
  <div class="g21 anim d2" style="margin-bottom:1rem">
    <div class="card"><div class="ch"><div><div class="ct">Acadience Kâ€“2 Â· Benchmark Distribution</div><div class="cs" id="acad-sub">All Students Â· All Windows</div></div><span class="tag tt">Stacked %</span></div>
      <div class="sl"><div class="si"><div class="sd" style="background:#4ade80"></div>Above</div><div class="si"><div class="sd" style="background:#4f8ef7"></div>At</div><div class="si"><div class="sd" style="background:#f59e0b"></div>Below</div><div class="si"><div class="sd" style="background:#fb7185"></div>Well Below</div></div>
      <div class="cw h280"><canvas id="acadStack"></canvas></div></div>
    <div class="card"><div class="ch"><div><div class="ct">Acadience Kâ€“2 Â· On/Above Trend</div><div class="cs" id="acad-line-sub">All subgroups Â· All Windows</div></div><span class="tag tb">Trend</span></div>
      <div class="cw h300"><canvas id="acadLine"></canvas></div></div>
  </div>
  <div class="card anim d3">
    <div class="ch"><div><div class="ct">Acadience Kâ€“2 Â· Equity Snapshot</div><div class="cs" id="acad-tbl-sub">MOY 2025â€“26</div></div><span class="tag tr">Gap Analysis</span></div>
    <table class="dt"><thead><tr><th>Subgroup</th><th>Above</th><th>At</th><th>Below</th><th>Well Below</th><th>On/Above Total</th><th>Gap vs All</th><th id="acad-base-th">vs Prior Year</th></tr></thead><tbody id="acadTbl"></tbody></table>
  </div>

  <!-- iReady Reading subsection -->
  <div class="sec-head" style="margin-top:2.5rem">
    <div class="sec-icon" style="background:rgba(52,212,176,.1)">ğŸ“–</div>
    <div class="sec-titles"><div class="sec-title" style="color:var(--p1)">Priority 1 Â· iReady Reading Gr 3â€“8</div><div class="sec-sub">All Students Receive a High Quality Academic Experience Â· Live from Google Sheets Â· Grade-level performance bands</div></div>
    <span class="sec-badge tt">Gr 3â€“8 Â· 5 Levels</span>
  </div>
  <div class="ins-row anim d1" id="readInsights"></div>
  <div class="win-filter-strip" id="readWinFilter">
    <span class="wfl">Window:</span>
    <button class="wfb active" onclick="setWinFilter('read','ALL',this)">All Years</button>
    <button class="wfb" onclick="setWinFilter('read','BOY',this)">BOY Only</button>
    <button class="wfb" onclick="setWinFilter('read','MOY',this)">MOY Only</button>
    <button class="wfb" onclick="setWinFilter('read','EOY',this)">EOY Only</button>
  </div>
  <div class="filter-strip" id="readFilter">
    <span class="fl">Subgroup:</span>
    <button class="fb active" onclick="setGroup('read','All Students',this)">All Students</button>
    <button class="fb" onclick="setGroup('read','Hispanics',this)">Hispanic</button>
    <button class="fb" onclick="setGroup('read','Black',this)">Black</button>
    <button class="fb" onclick="setGroup('read','ELL',this)">ELL</button>
    <button class="fb" onclick="setGroup('read','SWD',this)">SWD</button>
  </div>
  <div class="g2 anim d2" style="margin-bottom:1rem">
    <div class="card"><div class="ch"><div><div class="ct">iReady Reading Â· Grade-Level Distribution</div><div class="cs" id="read-sub">All Students Â· All Windows</div></div><span class="tag tt">Stacked %</span></div>
      <div class="sl"><div class="si"><div class="sd" style="background:#4ade80"></div>Mid/Above GL</div><div class="si"><div class="sd" style="background:#4f8ef7"></div>Early On GL</div><div class="si"><div class="sd" style="background:#f59e0b"></div>1 Below</div><div class="si"><div class="sd" style="background:#fb7185"></div>2 Below</div><div class="si"><div class="sd" style="background:#a78bfa"></div>3+ Below</div></div>
      <div class="cw h280"><canvas id="readStack"></canvas></div></div>
    <div class="card"><div class="ch"><div><div class="ct" id="readGroupTitle">iReady Reading Â· Mid/Above GL Â· Year-over-Year</div><div class="cs" id="readGroupSub">Current window vs prior year</div></div><span class="tag tb">Comparison</span></div>
      <div class="cw h280"><canvas id="readGroup"></canvas></div></div>
  </div>
  <div class="card anim d3">
    <div class="ch"><div><div class="ct">iReady Reading Â· Equity Snapshot</div><div class="cs" id="read-tbl-sub">MOY 2025â€“26</div></div><span class="tag tr">Gap Analysis</span></div>
    <table class="dt"><thead><tr><th>Subgroup</th><th>Mid/Above GL</th><th>Early On GL</th><th>1 Below</th><th>2 Below</th><th>3+ Below</th><th>On-Track Total</th><th class="base-th">vs Prior Year</th>/tr></thead><tbody id="readTbl"></tbody></table>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â• P3 MATH â•â•â•â•â•â•â•â• -->
<section class="section" id="p3">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(79,142,247,.1)">ğŸ”¢</div>
    <div class="sec-titles"><div class="sec-title" style="color:var(--p3)">Priority 3 Â· iReady Mathematics Gr 3â€“8</div><div class="sec-sub">All Students Receive a High Quality Academic Experience Â· Live from Google Sheets Â· Grade-level performance bands</div></div>
    <span class="sec-badge tb">Gr 3â€“8 Â· 5 Levels</span>
  </div>
  <div class="goal-banner" style="background:linear-gradient(135deg,rgba(79,142,247,.07),rgba(167,139,250,.05));border-color:rgba(79,142,247,.2)">
    <div class="gb-icon">ğŸ¯</div>
    <div class="gb-text"><div class="gb-label" style="color:var(--p3)">Priority 3 Goal</div><div class="gb-goal">By June 2026: <strong>+5% increase</strong> for All Students and <strong>+10% increase</strong> for Hispanic, Black, SWD, and ELL learners meeting or exceeding grade-level standards in mathematics.</div></div>
    <div class="gb-target" style="background:rgba(79,142,247,.1);color:var(--p3);border-color:rgba(79,142,247,.25)">Target: June 2026</div>
  </div>
  <div class="ins-row anim d1" id="mathInsights"></div>
  <div class="win-filter-strip" id="mathWinFilter">
    <span class="wfl">Window:</span>
    <button class="wfb active" onclick="setWinFilter('math','ALL',this)">All Years</button>
    <button class="wfb" onclick="setWinFilter('math','BOY',this)">BOY Only</button>
    <button class="wfb" onclick="setWinFilter('math','MOY',this)">MOY Only</button>
    <button class="wfb" onclick="setWinFilter('math','EOY',this)">EOY Only</button>
  </div>
  <div class="filter-strip" id="mathFilter">
    <span class="fl">Subgroup:</span>
    <button class="fb active" onclick="setGroup('math','All Students',this)">All Students</button>
    <button class="fb" onclick="setGroup('math','Hispanics',this)">Hispanic</button>
    <button class="fb" onclick="setGroup('math','Black',this)">Black</button>
    <button class="fb" onclick="setGroup('math','ELL',this)">ELL</button>
    <button class="fb" onclick="setGroup('math','SWD',this)">SWD</button>
  </div>
  <div class="g2 anim d2" style="margin-bottom:1rem">
    <div class="card"><div class="ch"><div><div class="ct">iReady Math Â· Grade-Level Distribution</div><div class="cs" id="math-sub">All Students Â· All Windows</div></div><span class="tag ta">Stacked %</span></div>
      <div class="sl"><div class="si"><div class="sd" style="background:#4ade80"></div>Mid/Above GL</div><div class="si"><div class="sd" style="background:#4f8ef7"></div>Early On GL</div><div class="si"><div class="sd" style="background:#f59e0b"></div>1 Below</div><div class="si"><div class="sd" style="background:#fb7185"></div>2 Below</div><div class="si"><div class="sd" style="background:#a78bfa"></div>3+ Below</div></div>
      <div class="cw h280"><canvas id="mathStack"></canvas></div></div>
    <div class="card"><div class="ch"><div><div class="ct" id="mathYoYTitle">iReady Math Â· Mid/Above GL Â· Year-over-Year</div><div class="cs" id="mathYoYSub">Current window vs prior year</div></div><span class="tag tb">YoY</span></div>
      <div class="cw h280"><canvas id="mathYoY"></canvas></div></div>
  </div>
  <div class="card anim d3">
    <div class="ch"><div><div class="ct">iReady Math Â· Equity Snapshot</div><div class="cs" id="math-tbl-sub">MOY 2025â€“26</div></div><span class="tag ta">Gap Analysis</span></div>
    <table class="dt"><thead><tr><th>Subgroup</th><th>Mid/Above GL</th><th>Early On GL</th><th>1 Below</th><th>2 Below</th><th>3+ Below</th><th>On-Track Total</th><th class="base-th">vs Prior Year</th>/tr></thead><tbody id="mathTbl"></tbody></table>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â• CHRONIC ABSENTEEISM â•â•â•â•â•â•â•â• -->
<!-- â•â•â•â•â•â•â•â• P4 â•â•â•â•â•â•â•â• -->
<section class="section" id="p4">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(167,139,250,.1)">ğŸ“</div>
    <div class="sec-titles">
      <div class="sec-title" style="color:var(--p4)">Priority 4 Â· College &amp; Career Ready</div>
      <div class="sec-sub">All students graduate college and career ready with a strong plan and pathway to economic security</div>
    </div>
    <span class="sec-badge" style="background:rgba(167,139,250,.1);color:var(--p4);border-color:rgba(167,139,250,.25)">Coming Soon</span>
  </div>
  <div class="coming-soon">
    <div class="cs-icon">ğŸ“</div>
    <div class="cs-title">Priority 4 Data Coming Soon</div>
    <div class="cs-desc">Graduation rates, Regents performance, and college/career readiness indicators will appear here once added to your Google Sheet.</div>
    <span class="cs-tag">â³ Awaiting data</span>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â• P5 â•â•â•â•â•â•â•â• -->
<section class="section" id="p5">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(251,146,60,.1)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
    <div class="sec-titles">
      <div class="sec-title" style="color:var(--p5)">Priority 5 Â· Family &amp; Community Engagement</div>
      <div class="sec-sub">All districts and schools are more inclusive and responsive for parents and families, including having more families choose NYC Public Schools</div>
    </div>
    <span class="sec-badge" style="background:rgba(251,146,60,.1);color:var(--p5);border-color:rgba(251,146,60,.25)">Coming Soon</span>
  </div>
  <div class="coming-soon">
    <div class="cs-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
    <div class="cs-title">Priority 5 Data Coming Soon</div>
    <div class="cs-desc">Family engagement survey results, school choice data, and community partnership metrics will appear here once added to your Google Sheet.</div>
    <span class="cs-tag">â³ Awaiting data</span>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â• ABSENTEEISM â•â•â•â•â•â•â•â• -->
<section class="section" id="ca-section">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(251,113,133,.1)">ğŸ“…</div>
    <div class="sec-titles"><div class="sec-title" style="color:var(--ca)">Chronic Absenteeism</div><div class="sec-sub">Supporting All Priorities Â· Live from Google Sheets Â· YTD monthly rates by school year</div></div>
    <span class="sec-badge tr">Multi-Year</span>
  </div>
  <div class="goal-banner" style="background:linear-gradient(135deg,rgba(251,113,133,.07),rgba(245,158,11,.05));border-color:rgba(251,113,133,.2)">
    <div class="gb-icon">ğŸ¯</div>
    <div class="gb-text"><div class="gb-label" style="color:var(--ca)">CA Reduction Goal</div><div class="gb-goal">By June 2026: CASE teams monitor CA data resulting in a <strong>4% reduction in CA rates</strong> for <strong>ELL, SWD, Hispanic, and Black learners</strong>.</div></div>
    <div class="gb-target" style="background:rgba(251,113,133,.1);color:var(--ca);border-color:rgba(251,113,133,.25)">Target: â€“4% by June 2026</div>
  </div>
  <div class="ca-grid anim d1" id="caCards"></div>
  <div class="g2 anim d2" style="margin-bottom:1rem">
    <div class="card"><div class="ch"><div><div class="ct">Chronic Absenteeism Â· Monthly YTD Rate</div><div class="cs">September through June</div></div><span class="tag tr">Multi-Year</span></div><div class="cw h320"><canvas id="caLine"></canvas></div></div>
    <div class="card"><div class="ch"><div><div class="ct" id="ca-yoy-title">Chronic Absenteeism Â· Current Month YTD Rate</div><div class="cs" id="ca-yoy-sub">Most recent month Â· year-over-year comparison</div></div><span class="tag ta">YoY BOY</span></div><div class="cw h320"><canvas id="caSep"></canvas></div></div>
  </div>
  <div class="card anim d3">
    <div class="ch"><div><div class="ct">Chronic Absenteeism Â· Monthly Detail</div><div class="cs">YTD chronic absenteeism rate</div></div><span class="tag tb">Full View</span></div>
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch"><table class="dt" id="caTblWrap"></table></div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â• SEL / P2 â•â•â•â•â•â•â•â• -->
<section class="section" id="p2">
  <div class="sec-head">
    <div class="sec-icon" style="background:rgba(245,158,11,.1)">ğŸ’›</div>
    <div class="sec-titles"><div class="sec-title" style="color:var(--p2)">Priority 2 Â· Social-Emotional Learning</div><div class="sec-sub">Live from Google Sheets Â· District Student Survey &amp; MindUP data</div></div>
    <span class="sec-badge ta">BOY Â· MOY Â· Live</span>
  </div>
  <div id="selContent"></div>
</section>

</div><!-- /page -->
</div><!-- /app -->

<footer>
  <div class="ft">D25 Â· State of the District Â· 2025â€“26 CEP Â· <span id="ft-updated"></span><br>Data feeds live from Google Sheets â€” update the spreadsheet to update this dashboard</div>
  <div class="fb2">
    <button class="btn btn-g" onclick="window.print()">ğŸ–¨ Export PDF</button>
    <button class="btn btn-p" onclick="hardRefresh()">â†º Refresh Data</button>
  </div>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SHEETS CSV URLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const URLS = {
  acad: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=0&single=true&output=csv',
  read: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=1211071891&single=true&output=csv',
  math: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=657974428&single=true&output=csv',
  ca:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=1538011971&single=true&output=csv',
  cep:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=2066501189&single=true&output=csv',
  sel:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8xmZm5dQBKDEqNr2MZ5pyfhBu5WHjUzGN9TTv71RcO6SJmbk7XvUKZIyTztQJsbQ8ywbBZE7dTdzt/pub?gid=1051368613&single=true&output=csv',
};

// â•â• CHART.JS SETUP â•â•
Chart.register(ChartDataLabels);
Chart.defaults.color = '#c8cfe0';  // â† brighter default text
Chart.defaults.font.family = "'IBM Plex Mono',monospace";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.boxWidth = 8;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 14;
Chart.defaults.plugins.datalabels.display = false;
const G = 'rgba(255,255,255,0.05)';
const C = {green:'#4ade80',blue:'#4f8ef7',amber:'#f59e0b',rose:'#fb7185',purple:'#a78bfa',teal:'#34d4b0',orange:'#fb923c',cyan:'#22d3ee'};

const STACK_LBL = {display:ctx=>ctx.dataset.data[ctx.dataIndex]>=8,color:'rgba(0,0,0,0.8)',font:{family:"'IBM Plex Mono',monospace",size:9,weight:'600'},formatter:v=>v+'%',anchor:'center',align:'center',padding:0,textShadowBlur:3,textShadowColor:'rgba(0,0,0,0.5)'};
const BAR_LBL   = {display:ctx=>ctx.dataset.data[ctx.dataIndex]>0,color:'#e8eaf2',font:{family:"'IBM Plex Mono',monospace",size:9,weight:'600'},formatter:v=>v+'%',anchor:'end',align:'end',offset:2};
const TT_BASE   = {backgroundColor:'rgba(16,20,32,0.97)',titleColor:'#e8eaf2',bodyColor:'#b0b8d0',borderColor:'rgba(255,255,255,0.12)',borderWidth:1,padding:12,cornerRadius:10,titleFont:{size:11,weight:'700'},footerFont:{size:9}};

let ci = {};
function mkChart(id, cfg){ if(ci[id]) ci[id].destroy(); ci[id] = new Chart(document.getElementById(id), cfg); }

// â•â• DETERMINE CURRENT WINDOW from today's date â•â•
// BOY = Octâ€“Dec, MOY = Janâ€“Mar, EOY = Mayâ€“Jun  (Apr = transitional â†’ MOY)
function currentWindow(){
  // BOY = Sep 5 â€“ Dec 31  |  MOY = Jan 1 â€“ Apr 30  |  EOY = May 1 â€“ Sep 4
  const now = new Date();
  const mo  = now.getMonth() + 1; // 1=Jan â€¦ 12=Dec
  const day = now.getDate();
  if(mo >= 1  && mo <= 4)                  return 'MOY'; // Janâ€“Apr
  if(mo >= 5  && (mo < 9 || (mo===9 && day<=4))) return 'EOY'; // May 1â€“Sep 4
  return 'BOY';                                            // Sep 5â€“Dec 31
}
const CUR_WIN = currentWindow();

// â•â• CSV PARSER â•â•
function parseCSV(text){
  const lines = text.trim().split('\n').filter(l=>l.trim());
  let headerIdx = 0;
  for(let i=0;i<Math.min(5,lines.length);i++){
    const cols = splitCSVLine(lines[i]);
    if(cols.filter(c=>c.trim().length>0).length >= 3){ headerIdx=i; break; }
  }
  const headers = splitCSVLine(lines[headerIdx]);
  return lines.slice(headerIdx+1).map(line=>{
    const vals = splitCSVLine(line);
    const obj  = {};
    headers.forEach((h,i)=>{ obj[h.trim().replace(/^"|"$/g,'')]=(vals[i]||'').trim().replace(/^"|"$/g,''); });
    return obj;
  }).filter(row=>Object.values(row).some(v=>v.trim().length>0));
}
function splitCSVLine(line){
  const result=[]; let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){inQ=!inQ;}
    else if(ch===','&&!inQ){result.push(cur);cur='';}
    else cur+=ch;
  }
  result.push(cur);
  return result;
}
function pct(v){ return parseFloat(String(v).replace('%',''))||0; }

// â•â• FETCH â€” 4 strategies, CORS-resilient â•â•
async function fetchCSV(url, label){
  const t = '&t=' + Date.now();
  const proxies = [
    u => 'https://corsproxy.io/?' + encodeURIComponent(u),
    u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
  ];
  try { const r=await fetch(url+t); if(r.ok){const tx=await r.text();if(tx.trim().length>10&&tx.includes(','))return parseCSV(tx);} } catch(e){}
  for(const proxy of proxies){
    try { const r=await fetch(proxy(url)); if(r.ok){const tx=await r.text();if(tx.trim().length>10&&tx.includes(','))return parseCSV(tx);} } catch(e){}
  }
  throw new Error('Could not load ' + label + '. Check the Sheet tab is published as CSV.');
}

// â•â• LOADER â•â•
function ldProgress(p,msg){ document.getElementById('ldBar').style.width=p+'%'; document.getElementById('ldStatus').textContent=msg; }
function ldStep(id,state){ document.getElementById(id).className='ld-step '+state; }
function ldHide(){ document.getElementById('loader').classList.add('done'); document.getElementById('app').classList.add('visible'); }

// â•â• DATA STORES â•â•
let ACAD={}, READ={}, MATH={}, CA_DATA=[], SEL_ROWS=[];

// â•â• WINDOW FILTER STATES â•â•
let acadWinFilter='ALL', readWinFilter='ALL', mathWinFilter='ALL';

// â•â• PARSE ACADIENCE â•â•
function parseAcad(rows){
  const out={};
  rows.forEach(r=>{
    const sgRaw = r['Subgroup']||r['subgroup']||Object.values(r)[1];
    const sg = sgRaw==='ENL'?'ELL':sgRaw; // normalise ENLâ†’ELL
    const win = r['Academic Year/Window']||Object.values(r)[0];
    if(!sg||!win) return;
    if(!out[sg]) out[sg]=[];
    // Supports both old format ("2023-24 Beginning of Year Performance")
    // and new format ("2023-24 BOY")
    // Output normalised to "BOY 23-24" so winType()="BOY", winYear()="23-24"
    let wShort = win
      .replace('Beginning of Year Performance','BOY').replace('Middle of Year Performance','MOY')
      .replace('End of Year Perfromance','EOY').replace('End of Year Performance','EOY').trim();
    // Now handle both "2023-24 BOY" (new) and "BOY 23-24" (already normalised)
    const yrMatch = wShort.match(/^(\d{4}-\d{2})\s+(BOY|MOY|EOY)$/i);
    if(yrMatch){
      // New format "2023-24 BOY" â†’ convert year "2023-24" â†’ "23-24"
      const fullYr = yrMatch[1]; // "2023-24"
      const shortYr = fullYr.slice(2,4)+'-'+fullYr.slice(-2); // "23-24"
      wShort = yrMatch[2].toUpperCase()+' '+shortYr; // "BOY 23-24"
    } else {
      // Old long format already had BOY/MOY/EOY substituted, still has full year
      wShort = wShort
        .replace('2023-24 ','23-24 ').replace('2024-25 ','24-25 ').replace('2025-26 ','25-26 ')
        .replace('2026-27 ','26-27 ').trim();
      // If still in "23-24 BOY" format, flip to "BOY 23-24"
      const flip = wShort.match(/^(\d{2}-\d{2})\s+(BOY|MOY|EOY)$/i);
      if(flip) wShort = flip[2].toUpperCase()+' '+flip[1];
    }
    const ab = pct(r['above benchmark']||r['Above Benchmark']||0);
    const at = pct(r['at benchmark']||r['At Benchmark']||0);
    const bl = pct(r['below benchmark']||r['Below Benchmark']||0);
    const wb = pct(r['well below benchmark']||r['Well Below Benchmark']||0);
    out[sg].push({ w:wShort, wFull:win, ab, at, bl, wb });
  });
  return out;
}

// â•â• PARSE iREADY â•â•
function parseIReady(rows){
  const out={};
  rows.forEach(r=>{
    const sgRaw = r['Subgroup']||r['subgroup']||Object.values(r)[1];
    const sg = sgRaw==='ENL'?'ELL':sgRaw; // normalise ENLâ†’ELL
    const win = r['Academic Year/Window']||Object.values(r)[0];
    if(!sg||!win) return;
    if(!out[sg]) out[sg]=[];
    // Supports both old format ("2023-24 Beginning of Year Performance")
    // and new format ("2023-24 BOY")
    // Output normalised to "BOY 23-24" so winType()="BOY", winYear()="23-24"
    let wShort = win
      .replace('Beginning of Year Performance','BOY').replace('Middle of Year Performance','MOY')
      .replace('End of Year Perfromance','EOY').replace('End of Year Performance','EOY').trim();
    // Now handle both "2023-24 BOY" (new) and "BOY 23-24" (already normalised)
    const yrMatch = wShort.match(/^(\d{4}-\d{2})\s+(BOY|MOY|EOY)$/i);
    if(yrMatch){
      // New format "2023-24 BOY" â†’ convert year "2023-24" â†’ "23-24"
      const fullYr = yrMatch[1]; // "2023-24"
      const shortYr = fullYr.slice(2,4)+'-'+fullYr.slice(-2); // "23-24"
      wShort = yrMatch[2].toUpperCase()+' '+shortYr; // "BOY 23-24"
    } else {
      // Old long format already had BOY/MOY/EOY substituted, still has full year
      wShort = wShort
        .replace('2023-24 ','23-24 ').replace('2024-25 ','24-25 ').replace('2025-26 ','25-26 ')
        .replace('2026-27 ','26-27 ').trim();
      // If still in "23-24 BOY" format, flip to "BOY 23-24"
      const flip = wShort.match(/^(\d{2}-\d{2})\s+(BOY|MOY|EOY)$/i);
      if(flip) wShort = flip[2].toUpperCase()+' '+flip[1];
    }
    const keys = Object.keys(r);
    const m  = pct(r['Mid or Above Grade Level']||r['mid or above grade level']||r[keys[3]]||0);
    const e  = pct(r['Early On Grade Level']||r['early on grade level']||r[keys[4]]||0);
    const o  = pct(r['1 Grade Level Below']||r['1 grade level below']||r[keys[5]]||0);
    const t  = pct(r['2 Grade Levels Below']||r['2 grade levels below']||r[keys[6]]||0);
    const th = pct(r['3 or More Grade Levels Below']||r['3 or more grade levels below']||r['3+ Grade Levels Below']||r[keys[7]]||0);
    out[sg].push({ w:wShort, wFull:win, m, e, o, t, th });
  });
  return out;
}

// â•â• PARSE CA â•â•
function parseCA(rows){
  const byMonth={};
  rows.forEach(r=>{
    const mo   = r['month']||r['Month'];
    const yr   = r['year']||r['Year'];
    const rate = pct(r['Average of ytd_ca_rate']||r['average of ytd_ca_rate']||Object.values(r)[2]);
    if(!mo||!yr) return;
    if(!byMonth[mo]) byMonth[mo]={month:mo};
    byMonth[mo][yr] = rate;
  });
  const monthOrder=['Sep','Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun'];
  return monthOrder.map(mo=>byMonth[mo]).filter(Boolean);
}

// â•â• PARSE SEL â•â•
function parseSEL(rows){
  // Robustly handles any column name variant the Sheet might export
  // Domain column may be "Domain: Overall", "Domain", "domain" etc.
  // Window column may be "Year/Window", "Window" etc.
  // Also handles positional fallback
  const out = [];
  if(!rows.length) return out;

  // Debug: log first row keys to console so we can see exact column names
  console.log('[SEL] Column keys:', Object.keys(rows[0]));
  console.log('[SEL] First row:', rows[0]);

  rows.forEach(r=>{
    const keys = Object.keys(r);
    // Window: first column
    const win = r['Year/Window']||r['year/window']||r['Window']||r['window']||r[keys[0]]||'';
    // Domain: second column â€” try many variants
    const domain = r['Domain: Overall']||r['Domain']||r['domain']||r['Domain: overall']||r[keys[1]]||'';
    if(!win.trim()||!domain.trim()) return;

    // Normalise window: "2025-26 BOY" â†’ "BOY 25-26"
    let wShort = win.trim();
    const yrMatch = wShort.match(/^(\d{4}-\d{2})\s+(BOY|MOY|EOY)$/i);
    if(yrMatch){
      const shortYr = yrMatch[1].slice(2,4)+'-'+yrMatch[1].slice(-2);
      wShort = yrMatch[2].toUpperCase()+' '+shortYr; // "BOY 25-26"
    }

    // Response columns â€” named lookup first, then smart positional
    // Actual sheet columns: SA, Agree, Fall (skip), Neutral, Disagree, Strongly Disagree
    const sa = pct(r['Strongly Agree']||r['strongly agree']||0) || pct(r[keys[2]]||0);
    const a  = pct(r['Agree']||r['agree']||0)                   || pct(r[keys[3]]||0);
    // Find Neutral, Disagree, SD by name first; positional skips the "Fall" column (index 4)
    const n  = pct(r['Neutral']||r['neutral']||0)               || pct(r[keys[5]]||0);
    const d  = pct(r['Disagree']||r['disagree']||0)             || pct(r[keys[6]]||0);
    const sd = pct(r['Strongly Disagree']||r['strongly disagree']||0) || pct(r[keys[7]]||0);

    // Only push if we got meaningful data
    if(sa+a+n+d+sd < 5) return; // skip empty/header rows

    out.push({ w:wShort, domain:domain.trim(), sa, a, n, d, sd });
  });

  console.log('[SEL] Parsed', out.length, 'rows. Windows:', [...new Set(out.map(r=>r.w))]);
  return out;
}

// â•â• HELPERS â•â•
function mostRecent(groupData){
  const g = groupData['All Students']||Object.values(groupData)[0]||[];
  if(!g.length) return 'â€”';
  // Prefer the most recent window that matches the current reporting period (BOY/MOY/EOY)
  // e.g. in February (MOY), show MOY 25-26 not EOY 24-25
  const matching = g.filter(r=>winType(r.w)===CUR_WIN);
  if(matching.length) return matching[matching.length-1].w;
  // Fallback: most recent window of any type
  return g[g.length-1].w;
}
// Get the window type (BOY/MOY/EOY) from a short label like "MOY 25-26"
function winType(w){ return w.split(' ')[0]; }
// Get the school year from a short label like "MOY 25-26" â†’ "25-26"
function winYear(w){ return w.split(' ')[1]||''; }
// Filter rows by window type
function filterByWin(rows, winFilter){
  if(winFilter==='ALL') return rows;
  return rows.filter(r=>winType(r.w)===winFilter);
}
// Previous school year label e.g. "25-26" â†’ "24-25"
function prevYear(yr){
  const [a,b]=yr.split('-');
  return (parseInt(a)-1)+'-'+(parseInt(b)-1);
}
// Find same-window row from prior year for YoY tooltip
function priorYearRow(data, grp, currentW){
  const type=winType(currentW), yr=winYear(currentW), prev=prevYear(yr);
  return data[grp]?.find(r=>winType(r.w)===type && winYear(r.w)===prev);
}

// â•â• DYNAMIC YoY WINDOW â€” based on current calendar date â•â•
// Returns the window label to use for YoY comparison (e.g. "BOY", "MOY", "EOY")
function yoyWindowLabel(){
  return CUR_WIN; // BOY/MOY/EOY determined at load time
}
function yoyWinFull(){ return {BOY:'BOY',MOY:'MOY',EOY:'EOY'}[CUR_WIN]; }

// â•â• RENDER ACADIENCE â•â•
function renderAcad(grp){
  const allRows = ACAD[grp]||[];
  if(!allRows.length) return;
  const rows = filterByWin(allRows, acadWinFilter);
  const L    = rows.map(r=>r.w);

  mkChart('acadStack',{type:'bar',data:{labels:L,datasets:[
    {label:'Above',     data:rows.map(r=>r.ab),backgroundColor:C.green,borderRadius:3,borderSkipped:false},
    {label:'At',        data:rows.map(r=>r.at),backgroundColor:C.blue, borderRadius:3,borderSkipped:false},
    {label:'Below',     data:rows.map(r=>r.bl),backgroundColor:C.amber,borderRadius:3,borderSkipped:false},
    {label:'Well Below',data:rows.map(r=>r.wb),backgroundColor:C.rose, borderRadius:3,borderSkipped:false},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},datalabels:STACK_LBL,
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label,
        label:ctx=>{const n=['Above Benchmark','At Benchmark','Below Benchmark','Well Below'];return ' '+n[ctx.datasetIndex]+': '+rows[ctx.dataIndex][['ab','at','bl','wb'][ctx.datasetIndex]]+'%';},
        afterBody:items=>{
          const r = rows[items[0].dataIndex];
          const priorRow = priorYearRow(ACAD, grp, r.w);
          const lines = ['','  âœ… On/Above Combined: '+(r.ab+r.at)+'%','  âš ï¸  Below Combined: '+(r.bl+r.wb)+'%'];
          if(priorRow){
            lines.push('');
            lines.push('  ğŸ“… Same window prior year ('+priorRow.w+'):');
            lines.push('     On/Above: '+(priorRow.ab+priorRow.at)+'%  Â·  Well Below: '+priorRow.wb+'%');
            const diff=(r.ab+r.at)-(priorRow.ab+priorRow.at);
            lines.push('     YoY change: '+(diff>=0?'+':'')+diff+' pts');
          }
          return lines;
        },
        footer:()=>'Subgroup: '+grp,
      }}},
    scales:{x:{stacked:true,grid:{color:G},ticks:{color:'#c8cfe0',maxRotation:45,font:{size:9}}},y:{stacked:true,grid:{color:G},max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // Trend line â€” filtered by window type, all subgroups
  // Use a shared label set so all datasets are same length
  const trendRows = filterByWin(ACAD['All Students']||allRows, acadWinFilter);
  const wins = trendRows.map(r=>r.w);
  const pal  = [C.teal,C.amber,C.purple,C.rose,C.blue];
  mkChart('acadLine',{type:'line',data:{labels:wins,datasets:Object.keys(ACAD).map((g,i)=>{
    // Map each label to its value â€” null if that window missing for this subgroup
    const dataMap = Object.fromEntries(filterByWin(ACAD[g],acadWinFilter).map(r=>[r.w,r.ab+r.at]));
    return {
      label:g,
      data:wins.map(w=>dataMap[w]??null),
      borderColor:pal[i%pal.length],backgroundColor:'transparent',
      spanGaps:false,tension:.4,pointRadius:5,borderWidth:g===grp?3:1.5,pointBackgroundColor:pal[i%pal.length],
    };
  })},options:{responsive:true,maintainAspectRatio:false,
    interaction:{mode:'index',intersect:false},
    plugins:{
      legend:{position:'bottom',labels:{color:'#c8cfe0',font:{size:10}}},
      datalabels:{display:ctx=>ctx.dataset.label===grp,color:ctx=>ctx.dataset.borderColor,font:{family:"'IBM Plex Mono',monospace",size:8.5,weight:'600'},formatter:v=>v+'%',anchor:'top',align:'top',offset:4,backgroundColor:'rgba(11,13,19,0.7)',borderRadius:3,padding:{top:2,bottom:2,left:4,right:4}},
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label,
        label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y+'% on/above',
        afterLabel:ctx=>{
          const all=ACAD['All Students']?.find(r=>r.w===ctx.label);
          const av=all?all.ab+all.at:null;
          if(ctx.dataset.label!=='All Students'&&av){ const g=ctx.parsed.y-av; return ' Gap vs All: '+(g>=0?'+':'')+g+' pts'; }
          return '';
        },
      }},
    },
    scales:{x:{grid:{color:G},ticks:{color:'#c8cfe0',maxRotation:45,font:{size:9}}},y:{grid:{color:G},min:0,max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  document.getElementById('acad-sub').textContent=grp+' Â· '+(acadWinFilter==='ALL'?'All Windows':acadWinFilter+' windows only');

  // Equity table â€” most recent window
  const latest = mostRecent(ACAD);
  const acadPriorW = priorYearRow(ACAD,'All Students',latest);
  document.getElementById('acad-tbl-sub').textContent=latest+(acadPriorW?' vs '+acadPriorW.w+' (YoY)':'');
  const allR   = ACAD['All Students']?.find(r=>r.w===latest);
  const allOA  = allR?allR.ab+allR.at:0;
  const tb = document.getElementById('acadTbl'); tb.innerHTML='';
  Object.keys(ACAD).forEach(g=>{
    const r=ACAD[g].find(x=>x.w===latest); if(!r) return;
    const oa=r.ab+r.at, gap=oa-allOA;
    // Compare vs same window prior year (e.g. MOY 25-26 vs MOY 24-25)
    const base=priorYearRow(ACAD,g,latest);
    const baseOA=base?base.ab+base.at:null;
    const chg=baseOA!=null?oa-baseOA:null;
    const baseLabel=base?base.w:'â€”';
    tb.innerHTML+=`<tr><td class="dn">${g}</td><td><span class="dp ${r.ab>=35?'pg':r.ab>=25?'pa':'pr'}">${r.ab}%</span></td><td class="dm">${r.at}%</td><td class="dm">${r.bl}%</td><td><span class="dp ${r.wb<=30?'pg':r.wb<=45?'pa':'pr'}">${r.wb}%</span></td><td><strong class="dm">${oa}%</strong></td><td><span class="dp ${gap>=0?'pg':gap>=-15?'pa':'pr'}">${gap>=0?'+':''}${gap}pts</span></td><td><span class="dp ${chg==null?'pb':chg>=0?'pg':'pr'}">${chg==null?'â€”':(chg>=0?'+':'')+chg+'pts'}</span></td></tr>`;
  });
}

// â•â• RENDER iREADY READING â•â•
function renderRead(grp){
  const allRows = READ[grp]||[]; if(!allRows.length) return;
  const rows    = filterByWin(allRows, readWinFilter);
  const L       = rows.map(r=>r.w);

  mkChart('readStack',{type:'bar',data:{labels:L,datasets:[
    {label:'Mid/Above',data:rows.map(r=>r.m), backgroundColor:C.green, borderRadius:3,borderSkipped:false},
    {label:'Early On', data:rows.map(r=>r.e), backgroundColor:C.blue,  borderRadius:3,borderSkipped:false},
    {label:'1 Below',  data:rows.map(r=>r.o), backgroundColor:C.amber, borderRadius:3,borderSkipped:false},
    {label:'2 Below',  data:rows.map(r=>r.t), backgroundColor:C.rose,  borderRadius:3,borderSkipped:false},
    {label:'3+ Below', data:rows.map(r=>r.th),backgroundColor:C.purple,borderRadius:3,borderSkipped:false},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},datalabels:STACK_LBL,
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label,
        label:ctx=>{const n=['Mid/Above GL','Early On GL','1 Level Below','2 Levels Below','3+ Levels Below'];const r=rows[ctx.dataIndex];const v=[r.m,r.e,r.o,r.t,r.th];return ' '+n[ctx.datasetIndex]+': '+v[ctx.datasetIndex]+'%';},
        afterBody:items=>{
          const r=rows[items[0].dataIndex];
          const priorRow=priorYearRow(READ,grp,r.w);
          const lines=['','  âœ… On-Track (Mid+Early): '+(r.m+r.e)+'%','  ğŸ”´ 3+ Below: '+r.th+'%'];
          if(priorRow){
            lines.push('');
            lines.push('  ğŸ“… Same window prior year ('+priorRow.w+'):');
            lines.push('     On-Track: '+(priorRow.m+priorRow.e)+'%  Â·  3+ Below: '+priorRow.th+'%');
            const diff=(r.m+r.e)-(priorRow.m+priorRow.e);
            lines.push('     YoY change: '+(diff>=0?'+':'')+diff+' pts');
          }
          return lines;
        },
        footer:()=>'Subgroup: '+grp,
      }}},
    scales:{x:{stacked:true,grid:{color:G},ticks:{color:'#c8cfe0',maxRotation:45,font:{size:9}}},y:{stacked:true,grid:{color:G},max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // Dynamic YoY comparison chart
  const yw      = yoyWinFull();
  const groups  = Object.keys(READ);
  const curYrW  = groups.length?READ[groups[0]]?.filter(r=>winType(r.w)===yw).slice(-1)[0]?.w:null;
  const prevYrW = curYrW?winType(curYrW)+' '+prevYear(winYear(curYrW)):null;
  mkChart('readGroup',{type:'bar',data:{labels:groups,datasets:[
    {label:prevYrW||'Prior Year '+yw,data:groups.map(g=>READ[g]?.find(r=>r.w===prevYrW)?.m||READ[g]?.find(r=>winType(r.w)===yw&&r.w!==curYrW)?.m||0),backgroundColor:'rgba(79,142,247,0.3)',borderRadius:6},
    {label:curYrW||'Current '+yw,   data:groups.map(g=>READ[g]?.find(r=>r.w===curYrW)?.m||0),backgroundColor:C.blue,borderRadius:6},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'bottom',labels:{color:'#c8cfe0'}},datalabels:BAR_LBL,
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label+' â€” iReady Reading Mid/Above GL',
        label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y+'%',
        afterBody:i=>{
          const g=i[0].label;
          const prev=READ[g]?.find(r=>r.w===prevYrW)?.m||0;
          const cur=READ[g]?.find(r=>r.w===curYrW)?.m||0;
          const diff=cur-prev;
          return ['',' YoY ('+prevYrW+' â†’ '+curYrW+'): '+(diff>=0?'+':'')+diff+' pts'];
        },
      }}},
    scales:{x:{grid:{display:false},ticks:{color:'#c8cfe0'}},y:{grid:{color:G},ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  document.getElementById('read-sub').textContent=grp+' Â· '+(readWinFilter==='ALL'?'All Windows':readWinFilter+' windows only');
  if(document.getElementById('readGroupSub')){
    document.getElementById('readGroupSub').textContent='iReady Reading Â· '+(curYrW||'Current')+' vs '+(prevYrW||'Prior Year')+' Â· Mid/Above Grade Level';
  }
  const latest=mostRecent(READ);
  const readPriorW = priorYearRow(READ,'All Students',latest);
  document.getElementById('read-tbl-sub').textContent=latest+(readPriorW?' vs '+readPriorW.w+' (YoY)':'');
  const tb=document.getElementById('readTbl'); tb.innerHTML='';
  groups.forEach(g=>{
    const r=READ[g]?.find(x=>x.w===latest); if(!r) return;
    const ot=r.m+r.e;
    const base=priorYearRow(READ,g,latest);
    const baseOT=base?base.m+base.e:null;
    const chg=baseOT!=null?ot-baseOT:null;
    tb.innerHTML+=`<tr><td class="dn">${g}</td><td><span class="dp ${r.m>=20?'pg':r.m>=10?'pa':'pr'}">${r.m}%</span></td><td class="dm">${r.e}%</td><td class="dm">${r.o}%</td><td class="dm">${r.t}%</td><td><span class="dp ${r.th<=25?'pg':r.th<=45?'pa':'pr'}">${r.th}%</span></td><td><strong class="dm">${ot}%</strong></td><td><span class="dp ${chg==null?'pb':chg>=0?'pg':'pr'}">${chg==null?'â€”':(chg>=0?'+':'')+chg+'pts'}</span></td></tr>`;
  });
}

// â•â• RENDER MATH â•â•
function renderMath(grp){
  const allRows=MATH[grp]||[]; if(!allRows.length) return;
  const rows   =filterByWin(allRows,mathWinFilter);
  const L      =rows.map(r=>r.w);

  mkChart('mathStack',{type:'bar',data:{labels:L,datasets:[
    {label:'Mid/Above',data:rows.map(r=>r.m), backgroundColor:C.green, borderRadius:3,borderSkipped:false},
    {label:'Early On', data:rows.map(r=>r.e), backgroundColor:C.blue,  borderRadius:3,borderSkipped:false},
    {label:'1 Below',  data:rows.map(r=>r.o), backgroundColor:C.amber, borderRadius:3,borderSkipped:false},
    {label:'2 Below',  data:rows.map(r=>r.t), backgroundColor:C.rose,  borderRadius:3,borderSkipped:false},
    {label:'3+ Below', data:rows.map(r=>r.th),backgroundColor:C.purple,borderRadius:3,borderSkipped:false},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},datalabels:STACK_LBL,
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label,
        label:ctx=>{const n=['Mid/Above GL','Early On GL','1 Level Below','2 Levels Below','3+ Levels Below'];const r=rows[ctx.dataIndex];const v=[r.m,r.e,r.o,r.t,r.th];return ' '+n[ctx.datasetIndex]+': '+v[ctx.datasetIndex]+'%';},
        afterBody:items=>{
          const r=rows[items[0].dataIndex];
          const priorRow=priorYearRow(MATH,grp,r.w);
          const lines=['','  âœ… On-Track: '+(r.m+r.e)+'%','  ğŸ”´ 3+ Below: '+r.th+'%'];
          if(priorRow){
            lines.push('');
            lines.push('  ğŸ“… Same window prior year ('+priorRow.w+'):');
            lines.push('     On-Track: '+(priorRow.m+priorRow.e)+'%  Â·  3+ Below: '+priorRow.th+'%');
            const diff=(r.m+r.e)-(priorRow.m+priorRow.e);
            lines.push('     YoY change: '+(diff>=0?'+':'')+diff+' pts');
          }
          return lines;
        },
        footer:()=>'Subgroup: '+grp,
      }}},
    scales:{x:{stacked:true,grid:{color:G},ticks:{color:'#c8cfe0',maxRotation:45,font:{size:9}}},y:{stacked:true,grid:{color:G},max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // Dynamic YoY
  const yw=yoyWinFull();
  const groups=Object.keys(MATH);
  const curYrW=groups.length?MATH[groups[0]]?.filter(r=>winType(r.w)===yw).slice(-1)[0]?.w:null;
  const prevYrW=curYrW?winType(curYrW)+' '+prevYear(winYear(curYrW)):null;
  mkChart('mathYoY',{type:'bar',data:{labels:groups,datasets:[
    {label:prevYrW||'Prior Year '+yw,data:groups.map(g=>MATH[g]?.find(r=>r.w===prevYrW)?.m||MATH[g]?.find(r=>winType(r.w)===yw&&r.w!==curYrW)?.m||0),backgroundColor:'rgba(245,158,11,0.3)',borderRadius:6},
    {label:curYrW||'Current '+yw,    data:groups.map(g=>MATH[g]?.find(r=>r.w===curYrW)?.m||0),backgroundColor:C.amber,borderRadius:6},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'bottom',labels:{color:'#c8cfe0'}},datalabels:BAR_LBL,
      tooltip:{...TT_BASE,callbacks:{
        title:i=>i[0].label+' â€” iReady Math Mid/Above GL',
        label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y+'%',
        afterBody:i=>{
          const g=i[0].label;
          const prev=MATH[g]?.find(r=>r.w===prevYrW)?.m||0;
          const cur=MATH[g]?.find(r=>r.w===curYrW)?.m||0;
          const diff=cur-prev;
          return ['',' YoY ('+prevYrW+' â†’ '+curYrW+'): '+(diff>=0?'+':'')+diff+' pts'];
        },
      }}},
    scales:{x:{grid:{display:false},ticks:{color:'#c8cfe0'}},y:{grid:{color:G},ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  const latest=mostRecent(MATH);
  document.getElementById('math-sub').textContent=grp+' Â· '+(mathWinFilter==='ALL'?'All Windows':mathWinFilter+' windows only');
  if(document.getElementById('mathYoYSub')){
    document.getElementById('mathYoYSub').textContent='iReady Math Â· '+(curYrW||'Current')+' vs '+(prevYrW||'Prior Year')+' Â· Mid/Above Grade Level';
  }
  const mathPriorW = priorYearRow(MATH,'All Students',latest);
  document.getElementById('math-tbl-sub').textContent=latest+(mathPriorW?' vs '+mathPriorW.w+' (YoY)':'');
  const tb=document.getElementById('mathTbl'); tb.innerHTML='';
  groups.forEach(g=>{
    const r=MATH[g]?.find(x=>x.w===latest); if(!r) return;
    const ot=r.m+r.e;
    const base=priorYearRow(MATH,g,latest);
    const baseOT=base?base.m+base.e:null;
    const chg=baseOT!=null?ot-baseOT:null;
    tb.innerHTML+=`<tr><td class="dn">${g}</td><td><span class="dp ${r.m>=20?'pg':r.m>=10?'pa':'pr'}">${r.m}%</span></td><td class="dm">${r.e}%</td><td class="dm">${r.o}%</td><td class="dm">${r.t}%</td><td><span class="dp ${r.th<=25?'pg':r.th<=45?'pa':'pr'}">${r.th}%</span></td><td><strong class="dm">${ot}%</strong></td><td><span class="dp ${chg==null?'pb':chg>=0?'pg':'pr'}">${chg==null?'â€”':(chg>=0?'+':'')+chg+'pts'}</span></td></tr>`;
  });
}

// â•â• RENDER CA â€” last 3 years only â•â•
function renderCA(){
  let allYears = [...new Set(CA_DATA.flatMap(r=>Object.keys(r).filter(k=>k!=='month')))].sort();
  // Keep only last 3 years
  const years = allYears.slice(-3);
  const colors = [C.amber, C.blue, C.teal]; // prior-prior, prior, current
  const months = CA_DATA.map(r=>r.month);

  // Year avg cards (3 years)
  const cc=document.getElementById('caCards'); cc.innerHTML='';
  // Override grid to 3 columns
  cc.style.gridTemplateColumns='repeat(3,1fr)';
  years.forEach((yr,i)=>{
    const vals=CA_DATA.map(r=>r[yr]).filter(v=>v!=null&&!isNaN(v));
    if(!vals.length) return;
    const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
    const pv=i>0?CA_DATA.map(r=>r[years[i-1]]).filter(v=>v!=null&&!isNaN(v)):null;
    const pa=pv&&pv.length?(pv.reduce((a,b)=>a+b,0)/pv.length).toFixed(1):null;
    const delta=pa?(avg-pa).toFixed(1):null;
    const col=avg>20?'var(--rose)':avg>16?'var(--amber)':'var(--teal)';
    const trCol=delta===null?'var(--text3)':delta<0?'var(--teal)':'var(--rose)';
    const isLatest=i===years.length-1;
    cc.innerHTML+=`<div class="cac" style="${isLatest?'border-color:var(--ca);border-width:2px':''}"><div class="cac-yr">${yr}${isLatest?' Â· Current':''}</div><div class="cac-val" style="color:${col}">${avg}%</div><div class="cac-tr" style="color:${trCol}">${delta===null?'Baseline':delta<0?'â–¼ '+Math.abs(delta)+'pts':'â–² '+Math.abs(delta)+'pts'}</div></div>`;
  });

  mkChart('caLine',{type:'line',data:{labels:months,datasets:years.map((yr,i)=>({
    label:yr,
    data:CA_DATA.map(r=>r[yr]??null),
    borderColor:colors[i],backgroundColor:'transparent',
    tension:.4,pointRadius:5,spanGaps:false,
    borderWidth:i===years.length-1?3:i===years.length-2?2:1.5,
    borderDash:i===0?[5,3]:[],
    pointBackgroundColor:colors[i],
  }))},options:{responsive:true,maintainAspectRatio:false,
    interaction:{mode:'index',intersect:false},
    plugins:{
      legend:{position:'bottom',labels:{color:'#c8cfe0',font:{size:10}}},
      datalabels:{
        display:ctx=>(ctx.dataset.label===years[years.length-1]||ctx.dataset.label===years[years.length-2])&&ctx.dataset.data[ctx.dataIndex]!=null,
        color:ctx=>ctx.dataset.borderColor,
        font:{family:"'IBM Plex Mono',monospace",size:8,weight:'600'},
        formatter:v=>v!=null?v+'%':'',
        anchor:'top',align:'top',offset:3,
        backgroundColor:'rgba(11,13,19,0.75)',borderRadius:3,padding:{top:1,bottom:1,left:3,right:3},
      },
      tooltip:{...TT_BASE,footerColor:'#fb7185',callbacks:{
        title:i=>i[0].label+' â€” CA YTD Rate',
        label:ctx=>ctx.parsed.y!=null?' '+ctx.dataset.label+': '+ctx.parsed.y+'%':' '+ctx.dataset.label+': n/a',
        afterBody:items=>{
          const validItems=items.filter(i=>i.parsed.y!=null);
          if(validItems.length>=2){
            const cur=validItems[validItems.length-1].parsed.y;
            const prev=validItems[validItems.length-2].parsed.y;
            const diff=(cur-prev).toFixed(1);
            return ['', ' YoY change: '+(diff<0?'â–¼ '+Math.abs(diff):'â–² '+diff)+'%'];
          }
          return [];
        },
        footer:()=>'Goal: 4% reduction for ELL, SWD, Hispanic, Black',
      }},
    },
    scales:{x:{grid:{color:G},ticks:{color:'#c8cfe0'}},y:{grid:{color:G},min:8,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // Current-month bar â€” find most recent month that has data for the latest year
  const latestYr=years[years.length-1];
  const monthsWithData = CA_DATA.filter(r=>r[latestYr]!=null);
  const curMonthRow = monthsWithData.length ? monthsWithData[monthsWithData.length-1] : CA_DATA.find(r=>r.month==='Sep');
  const curMonthName = curMonthRow ? curMonthRow.month : 'Sep';
  const sepVals=years.map(yr=>curMonthRow?curMonthRow[yr]??null:null);
  // Update chart card subtitle
  const caYoYSubEl = document.getElementById('ca-yoy-sub');
  if(caYoYSubEl) caYoYSubEl.textContent = curMonthName+' YTD Â· year-over-year comparison';
  const caYoYTitleEl = document.getElementById('ca-yoy-title');
  if(caYoYTitleEl) caYoYTitleEl.textContent = 'Chronic Absenteeism Â· '+curMonthName+' YTD Rate';
  mkChart('caSep',{type:'bar',data:{labels:years,datasets:[{
    label:curMonthName+' YTD Rate',data:sepVals,
    backgroundColor:sepVals.map(v=>v==null?'transparent':v>17?'rgba(251,113,133,.7)':v>14?'rgba(245,158,11,.7)':'rgba(52,212,176,.7)'),
    borderRadius:8,
  }]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},
      datalabels:{display:ctx=>ctx.dataset.data[ctx.dataIndex]!=null,color:'rgba(255,255,255,.9)',font:{family:"'IBM Plex Mono',monospace",size:10,weight:'700'},formatter:v=>v!=null?v+'%':'',anchor:'center',align:'center'},
      tooltip:{...TT_BASE,footerColor:'#fb7185',callbacks:{
        title:i=>i[0].label+' â€” '+curMonthName+' YTD',
        label:ctx=>' Rate: '+ctx.parsed.y+'%',
        afterLabel:ctx=>{const v=ctx.parsed.y;return ' Status: '+(v>17?'âš ï¸ Above threshold':v>14?'ğŸŸ¡ Moderate':'âœ… Below target');},
        footer:()=>'4% reduction goal vs prior year',
      }}},
    scales:{x:{grid:{display:false},ticks:{color:'#c8cfe0'}},y:{grid:{color:G},min:8,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // Table â€” 3 years
  const tbl=document.getElementById('caTblWrap');
  let html=`<thead><tr><th>Month</th>${years.map(y=>`<th>${y}</th>`).join('')}<th>vs Prior Year</th></tr></thead><tbody>`;
  CA_DATA.forEach(row=>{
    const curr=row[latestYr], prev=row[years[years.length-2]];
    const trend=curr!=null&&prev!=null
      ?`<span class="dp ${curr<prev?'pg':curr>prev?'pr':'pb'}">${curr<prev?'â–¼ '+(prev-curr).toFixed(1)+'pts':curr>prev?'â–² '+(curr-prev).toFixed(1)+'pts':'â€”'}</span>`
      :'<span style="color:var(--text3);font-size:.7rem">Pending</span>';
    html+=`<tr><td class="dn">${row.month}</td>${years.map(y=>`<td class="dm">${row[y]!=null?row[y]+'%':'â€”'}</td>`).join('')}<td>${trend}</td></tr>`;
  });
  tbl.innerHTML=html+'</tbody>';
}

// â•â• GOAL TRACKER â€” baseline = EOY 24-25, mid-year checkpoints â•â•
function renderTargets(){
  const container=document.getElementById('targetRow'); container.innerHTML='';
  let currentSection = '';

  // â”€â”€ Window context â”€â”€
  // BOY: full goal by EOY. MOY: half-goal checkpoint. EOY: full goal.
  const isMOY = CUR_WIN === 'MOY';
  const isBOY = CUR_WIN === 'BOY';

  // â”€â”€ Baseline â”€â”€
  const baselineWin = 'EOY 24-25';

  // â”€â”€ Goals by subgroup â”€â”€
  const GOAL_BY_GRP = {'All Students':5,'Hispanics':10,'Black':10,'ELL':10,'SWD':10};
  const SUBGROUPS   = ['All Students','Hispanics','Black','ELL','SWD'];
  const METRICS = [
    {section:'P1 Â· Acadience Kâ€“2 Â· On/Above Benchmark',       tc:'var(--p1)',   data:ACAD, calc:r=>r.ab+r.at},
    {section:'P1 Â· iReady Reading Â· Mid/Above + Early On GL', tc:'var(--teal)', data:READ, calc:r=>r.m+r.e},
    {section:'P3 Â· iReady Math Â· Mid/Above + Early On GL',    tc:'var(--blue)', data:MATH, calc:r=>r.m+r.e},
  ];

  // â”€â”€ Period label for the header banner â”€â”€
  const periodLabel = isMOY ? 'Mid-Year Checkpoint (MOY)' : isBOY ? 'Beginning of Year' : 'End of Year';
  const periodNote  = isMOY
    ? 'Mid-year target = baseline + Â½ of annual goal. Full target due June 2026.'
    : isBOY
    ? 'Early-year snapshot. Full annual targets due June 2026.'
    : 'End-of-year targets. Full annual goals.';

  // Period banner across full width
  container.innerHTML = `<div style="grid-column:1/-1;background:rgba(245,158,11,${isMOY?'.08':'.04'});border:1px solid rgba(245,158,11,${isMOY?'.3':'.12'});border-radius:12px;padding:.85rem 1.2rem;margin-bottom:.5rem;display:flex;align-items:center;gap:.9rem">
    <div style="font-size:1.3rem">${isMOY?'ğŸ¯':isBOY?'ğŸŒ±':'ğŸ'}</div>
    <div>
      <div style="font-family:var(--ff-h);font-size:.9rem;font-weight:800;color:var(--amber)">${periodLabel}</div>
      <div style="font-family:var(--ff-m);font-size:.65rem;color:var(--text2);margin-top:.2rem">${periodNote}</div>
    </div>
    <div style="margin-left:auto;font-family:var(--ff-m);font-size:.62rem;color:var(--text3);text-align:right">Annual goal window<br>Sep 2025 â€“ Jun 2026</div>
  </div>`;

  // â”€â”€ Build targets array â”€â”€
  const targets = [];
  METRICS.forEach(met=>{
    SUBGROUPS.forEach(sg=>{
      targets.push({
        label:   sg==='Hispanics'?'Hispanic':sg,
        section: met.section, tc: met.tc, grp: sg,
        data:    met.data, annualGoal: GOAL_BY_GRP[sg], calc: met.calc,
      });
    });
  });

  targets.forEach(t=>{
    // Section header
    if(t.section !== currentSection){
      currentSection = t.section;
      container.innerHTML += `<div style="grid-column:1/-1;padding:.6rem 0 .2rem;border-top:1px solid var(--border);margin-top:.6rem">
        <span style="font-family:var(--ff-m);font-size:.63rem;color:var(--text2);text-transform:uppercase;letter-spacing:.1em">${t.section}</span>
      </div>`;
    }

    // â”€â”€ Data â”€â”€
    const baseRow = t.data[t.grp]?.find(r=>r.w===baselineWin||r.w==='EOY 24-5'||r.w==='EOY 2024-25');
    const latest  = mostRecent(t.data);
    const curRow  = t.data[t.grp]?.find(r=>r.w===latest);

    if(!baseRow||!curRow){
      container.innerHTML+=`<div class="target-card" style="--tc:${t.tc};cursor:zoom-in" onclick="openCardZoom(this)">
        <div class="tc-label">${t.label}</div>
        <div style="font-family:var(--ff-m);font-size:.7rem;color:var(--text3);margin-top:.3rem">No EOY 24-25 baseline in Sheet</div>
      </div>`;
      return;
    }

    const base       = +t.calc(baseRow).toFixed(1);
    const cur        = +t.calc(curRow).toFixed(1);
    const annualGoal = t.annualGoal;
    const eoyTarget  = +(base + annualGoal).toFixed(1);       // full year target
    const moyTarget  = +(base + annualGoal/2).toFixed(1);     // mid-year checkpoint = baseline + half goal

    // What are we tracking against RIGHT NOW?
    const activeTarget = isMOY ? moyTarget : eoyTarget;
    const activeGoalPts = isMOY ? annualGoal/2 : annualGoal;

    const gained   = +(cur - base).toFixed(1);
    const needed   = +(activeTarget - cur).toFixed(1);        // pts still needed
    // Progress bar: % of the ACTIVE target achieved (from baseline)
    const progress = Math.min(Math.max((gained / activeGoalPts)*100, 0), 100);

    // Status: on track if at or above active checkpoint
    const onTrack  = cur >= activeTarget;
    const ahead    = cur > activeTarget;
    const statusCol = ahead ? 'var(--green)' : onTrack ? 'var(--teal)' : 'var(--amber)';
    const statusLbl = ahead ? 'Ahead âœ¦' : onTrack ? 'On Track âœ“' : 'Watch âš ';

    // Progress bar segments: show baselineâ†’moy checkpointâ†’eoy target markers
    // Bar fills from 0â†’gained relative to annual goal span
    const barPctOfAnnual = Math.min(Math.max((gained / annualGoal)*100, 0), 100);
    const moyMarkerPct   = 50; // MOY checkpoint is always at 50% of bar
    const cursorColor    = onTrack ? 'var(--green)' : 'var(--amber)';

    container.innerHTML+=`<div class="target-card" style="--tc:${t.tc};cursor:zoom-in" onclick="openCardZoom(this)">

      <!-- Subgroup label -->
      <div class="tc-label">${t.label}</div>

      <!-- Current value â€” large -->
      <div class="tc-current" style="color:${t.tc}">${cur}%</div>

      <!-- Three-tier milestone row -->
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:.15rem;margin:.5rem 0 .25rem;text-align:center">
        <div>
          <div style="font-family:var(--ff-m);font-size:.55rem;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">Baseline</div>
          <div style="font-family:var(--ff-h);font-size:.9rem;color:var(--text2)">${base}%</div>
          <div style="font-family:var(--ff-m);font-size:.5rem;color:var(--text3)">EOY 24-25</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 .3rem">
          <div style="width:1px;flex:1;background:var(--border)"></div>
        </div>
        <div>
          ${isMOY ? `
          <div style="font-family:var(--ff-m);font-size:.55rem;color:var(--amber);text-transform:uppercase;letter-spacing:.06em">MOY Target â˜…</div>
          <div style="font-family:var(--ff-h);font-size:.9rem;color:var(--amber)">${moyTarget}%</div>
          <div style="font-family:var(--ff-m);font-size:.5rem;color:var(--text3)">+${annualGoal/2}pts checkpoint</div>
          ` : `
          <div style="font-family:var(--ff-m);font-size:.55rem;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">EOY Target</div>
          <div style="font-family:var(--ff-h);font-size:.9rem;color:var(--text2)">${eoyTarget}%</div>
          <div style="font-family:var(--ff-m);font-size:.5rem;color:var(--text3)">+${annualGoal}pts by Jun 2026</div>
          `}
        </div>
      </div>

      <!-- Progress bar â€” full width, markers for MOY & EOY -->
      <div style="position:relative;margin:.55rem 0 .3rem">
        <!-- Track -->
        <div style="height:7px;background:rgba(255,255,255,.07);border-radius:100px;overflow:visible;position:relative">
          <!-- Fill -->
          <div class="tc-bar-fill" data-w="${barPctOfAnnual}" style="height:100%;width:0%;background:${t.tc};border-radius:100px;transition:width .8s cubic-bezier(.4,0,.2,1)"></div>
          <!-- MOY marker line -->
          <div style="position:absolute;top:-3px;bottom:-3px;left:${moyMarkerPct}%;width:2px;background:var(--amber);border-radius:2px" title="MOY checkpoint"></div>
          <!-- EOY end cap -->
          <div style="position:absolute;top:-3px;bottom:-3px;right:0;width:2px;background:#f87171;border-radius:2px;opacity:.7" title="EOY target"></div>
        </div>
        <!-- Labels under bar -->
        <div style="display:flex;justify-content:space-between;margin-top:.3rem">
          <span style="font-family:var(--ff-m);font-size:.5rem;color:var(--text3)">Base ${base}%</span>
          <span style="font-family:var(--ff-m);font-size:.5rem;color:var(--amber)">MOY ${moyTarget}%</span>
          <span style="font-family:var(--ff-m);font-size:.5rem;color:#f87171;font-weight:700">EOY ${eoyTarget}%</span>
        </div>
      </div>

      <!-- Status row -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.35rem">
        <span style="font-family:var(--ff-m);font-size:.65rem;font-weight:700;color:${gained>=0?'var(--green)':'var(--rose)'}">${gained>=0?'+':''}${gained} pts gained</span>
        <span style="font-family:var(--ff-m);font-size:.65rem;font-weight:700;color:${statusCol}">${statusLbl}</span>
      </div>

      <!-- Needed to hit active checkpoint -->
      ${needed>0 ? `<div style="font-family:var(--ff-m);font-size:.58rem;color:var(--text3);margin-top:.2rem">Need +${needed}pts to reach ${isMOY?'MOY':'EOY'} target</div>` : `<div style="font-family:var(--ff-m);font-size:.58rem;color:var(--green);margin-top:.2rem">âœ“ ${isMOY?'MOY checkpoint':'EOY target'} reached${ahead?' â€” '+Math.abs(needed)+'pts ahead':''}</div>`}

    </div>`;
  });

  // Animate bars
  setTimeout(()=>{ document.querySelectorAll('.tc-bar-fill').forEach(b=>{ b.style.width=b.dataset.w+'%'; }); }, 400);
}

// â•â• HERO KPIs â•â•
function updateHeroKPIs(){
  const aLatest=mostRecent(ACAD);
  const aRow=ACAD['All Students']?.find(r=>r.w===aLatest);
  if(aRow){ document.getElementById('hkpi-acad').textContent=(aRow.ab+aRow.at)+'%'; }
  document.getElementById('hkpi-window').textContent=aLatest||'â€”';
  const rLatest=mostRecent(READ);
  const rRow=READ['All Students']?.find(r=>r.w===rLatest);
  if(rRow){ document.getElementById('hkpi-read').textContent=(rRow.m+rRow.e)+'%'; }
  const caYears=[...new Set(CA_DATA.flatMap(r=>Object.keys(r).filter(k=>k!=='month')))].sort();
  const latestYr=caYears[caYears.length-1];
  if(latestYr){
    const lastWithData=[...CA_DATA].reverse().find(r=>r[latestYr]!=null);
    if(lastWithData) document.getElementById('hkpi-ca').textContent=lastWithData[latestYr]+'%';
  }
}

// â•â• INSIGHT CARDS â•â•
function buildInsights(containerId,data,type){
  const el=document.getElementById(containerId);
  const latest=mostRecent(data);
  const allRow=data['All Students']?.find(r=>r.w===latest);
  if(!allRow){el.innerHTML='';return;}
  if(type==='acad'){
    const oa=allRow.ab+allRow.at;
    const ell=data['ELL']?.find(r=>r.w===latest);
    const swd=data['SWD']?.find(r=>r.w===latest);
    el.innerHTML=`
      <div class="ins" style="--ic:var(--teal)"><div class="il">All Students Â· On/Above (${latest})</div><div class="iv">${oa}%</div><div class="id">Above+At benchmark combined. Tracking toward June 2026 +5% goal.</div></div>
      <div class="ins" style="--ic:var(--rose)"><div class="il">ELL Â· Well Below (${latest})</div><div class="iv">${ell?ell.wb+'%':'â€”'}</div><div class="id">Highest well-below rate. NYSESLAT proficiency advancement is the ELL-specific metric.</div></div>
      <div class="ins" style="--ic:var(--amber)"><div class="il">SWD Â· Well Below (${latest})</div><div class="iv">${swd?swd.wb+'%':'â€”'}</div><div class="id">Tracking toward 10% improvement goal for SWD subgroup.</div></div>`;
  } else {
    const ot=allRow.m+allRow.e;
    const ell=data['ELL']?.find(r=>r.w===latest);
    const blk=data['Black']?.find(r=>r.w===latest);
    const blkBoy=data['Black']?.find(r=>r.w.includes('BOY 25'));
    const blkGain=blk&&blkBoy?blk.m-blkBoy.m:null;
    const col=type==='read'?'var(--blue)':'var(--amber)';
    el.innerHTML=`
      <div class="ins" style="--ic:${col}"><div class="il">All Students Â· On-Track (${latest})</div><div class="iv">${ot}%</div><div class="id">Mid/Above + Early On Grade Level combined.</div></div>
      <div class="ins" style="--ic:var(--rose)"><div class="il">ELL Â· 3+ Levels Below (${latest})</div><div class="iv">${ell?ell.th+'%':'â€”'}</div><div class="id">Largest concentration significantly below grade level.</div></div>
      <div class="ins" style="--ic:var(--purple)"><div class="il">Black Students Â· Within-Year Gain</div><div class="iv">${blkGain!=null?(blkGain>=0?'+':'')+blkGain+' pts':'â€”'}</div><div class="id">Mid/Above GL change from BOY to ${latest}.</div></div>`;
  }
}

// â•â• SEL â•â•
function renderSEL(){
  const el = document.getElementById('selContent');
  if(!SEL_ROWS.length||Object.keys(SEL_ROWS[0]).every(k=>!SEL_ROWS[0][k])){
    el.innerHTML=`<div class="coming-soon"><div class="cs-icon">ğŸ’›</div><div class="cs-title">SEL Data Coming Soon</div><div class="cs-desc">Priority 2 data will appear here once added to your Google Sheet.</div><span class="cs-tag">â³ Awaiting data</span></div>`;
    return;
  }

  const selData = parseSEL(SEL_ROWS);
  if(!selData.length){ el.innerHTML='<div class="fetch-error">Could not parse SEL data â€” check column names in Sheet.</div>'; return; }

  // â”€â”€ Get unique windows and domains â”€â”€
  const windows = [...new Set(selData.map(r=>r.w))];
  const allDomains = [...new Set(selData.map(r=>r.domain))].filter(d=>d!=='Average');
  const domains = allDomains; // all except Average which we handle separately

  // â”€â”€ Current window (prefer CUR_WIN match, else last) â”€â”€
  const curWinRows = windows.filter(w=>winType(w)===CUR_WIN);
  const curWin = curWinRows.length ? curWinRows[curWinRows.length-1] : windows[windows.length-1];
  // Prior window: same type, prior year
  const prevWinKey = winType(curWin)+' '+prevYear(winYear(curWin));
  const prevWin = windows.find(w=>w===prevWinKey) || null;

  // â”€â”€ Helper: get row for a domain+window â”€â”€
  function getRow(win, domain){ return selData.find(r=>r.w===win&&r.domain===domain); }
  function posScore(r){ return r ? r.sa+r.a : null; } // Strongly Agree + Agree = "Positive"

  // â”€â”€ Goal banner â”€â”€
  const curAvg = getRow(curWin,'Average');
  const prevAvg = prevWin ? getRow(prevWin,'Average') : null;
  const curPos = curAvg ? posScore(curAvg) : null;
  const prevPos = prevAvg ? posScore(prevAvg) : null;
  const diff = (curPos!=null&&prevPos!=null) ? (curPos-prevPos).toFixed(1) : null;

  // â”€â”€ Build insight cards â”€â”€
  const avgRow = curAvg;
  const topDomain = domains.map(d=>({d,v:posScore(getRow(curWin,d))||0})).sort((a,b)=>b.v-a.v)[0];
  const botDomain = domains.map(d=>({d,v:posScore(getRow(curWin,d))||0})).sort((a,b)=>a.v-b.v)[0];

  let html = `
  <div class="goal-banner" style="background:linear-gradient(135deg,rgba(245,158,11,.07),rgba(251,188,5,.05));border-color:rgba(245,158,11,.2)">
    <div class="gb-icon">ğŸ¯</div>
    <div class="gb-text">
      <div class="gb-label" style="color:var(--p2)">Priority 2 Goal</div>
      <div class="gb-goal">By June 2026: <strong>+10% increase</strong> in student-to-student relationships and students reporting MindUP curriculum helps manage emotions, stay focused, and make better choices.</div>
    </div>
    <div class="gb-target" style="background:rgba(245,158,11,.1);color:var(--amber);border-color:rgba(245,158,11,.25)">Target: June 2026</div>
  </div>

  <div class="ins-row" style="margin-bottom:1.25rem">
    <div class="ins" style="--ic:var(--amber)">
      <div class="il">Positive Responses Â· ${curWin}</div>
      <div class="iv">${curPos!=null?curPos+'%':'â€”'}</div>
      <div class="id">Strongly Agree + Agree combined across all SEL domains.</div>
    </div>
    <div class="ins" style="--ic:var(--${diff==null?'text3':parseFloat(diff)>=0?'green':'rose'})">
      <div class="il">YoY Change vs ${prevWin||'Prior Year'}</div>
      <div class="iv">${diff!=null?(parseFloat(diff)>=0?'+':'')+diff+'pts':'â€”'}</div>
      <div class="id">Change in positive responses (SA+A) vs same window prior year.</div>
    </div>
    <div class="ins" style="--ic:var(--green)">
      <div class="il">Strongest Domain Â· ${curWin}</div>
      <div class="iv" style="font-size:1.1rem;line-height:1.2">${topDomain?topDomain.d:'â€”'}</div>
      <div class="id">${topDomain?topDomain.v+'% positive responses':''}</div>
    </div>
  </div>

  <div class="g2" style="margin-bottom:1rem">
    <div class="card">
      <div class="ch">
        <div><div class="ct">SEL Survey Â· Domain Breakdown</div><div class="cs" id="sel-bar-sub">${curWin} Â· Positive Responses (SA + Agree)</div></div>
        <span class="tag ta">All Domains</span>
      </div>
      <div class="cw h300"><canvas id="selBar"></canvas></div>
    </div>
    <div class="card">
      <div class="ch">
        <div><div class="ct">SEL Survey Â· Average Score Trend</div><div class="cs">All available windows Â· Positive responses %</div></div>
        <span class="tag tb">Trend</span>
      </div>
      <div class="cw h300"><canvas id="selLine"></canvas></div>
    </div>
  </div>

  <div class="card" style="margin-bottom:1rem">
    <div class="ch">
      <div><div class="ct">SEL Survey Â· Full Response Detail</div><div class="cs" id="sel-tbl-sub">${curWin} Â· All domains Â· All response bands</div></div>
      <span class="tag tp">Detail</span>
    </div>
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
      <table class="dt" id="selTbl">
        <thead><tr>
          <th>Domain</th>
          <th style="color:#4ade80">Strongly Agree</th>
          <th style="color:#4f8ef7">Agree</th>
          <th>Positive Total</th>
          <th>Neutral</th>
          <th style="color:#fb7185">Disagree</th>
          <th style="color:#a78bfa">Strongly Disagree</th>
          ${prevWin?`<th>vs ${prevWin}</th>`:''}
        </tr></thead>
        <tbody id="selTblBody"></tbody>
      </table>
    </div>
  </div>`;

  el.innerHTML = html;

  // â”€â”€ Bar chart: domain comparison current window â”€â”€
  const barDomains = [...domains, 'Average'];
  const saVals  = barDomains.map(d=>{ const r=getRow(curWin,d); return r?r.sa:0; });
  const aVals   = barDomains.map(d=>{ const r=getRow(curWin,d); return r?r.a:0; });
  const nVals   = barDomains.map(d=>{ const r=getRow(curWin,d); return r?r.n:0; });
  const dVals   = barDomains.map(d=>{ const r=getRow(curWin,d); return r?r.d:0; });
  const sdVals  = barDomains.map(d=>{ const r=getRow(curWin,d); return r?r.sd:0; });

  mkChart('selBar',{type:'bar',data:{labels:barDomains,datasets:[
    {label:'Strongly Agree',data:saVals, backgroundColor:C.green, borderRadius:3,borderSkipped:false},
    {label:'Agree',         data:aVals,  backgroundColor:'rgba(79,142,247,.7)', borderRadius:3,borderSkipped:false},
    {label:'Neutral',       data:nVals,  backgroundColor:'rgba(245,158,11,.5)', borderRadius:3,borderSkipped:false},
    {label:'Disagree',      data:dVals,  backgroundColor:'rgba(251,113,133,.5)', borderRadius:3,borderSkipped:false},
    {label:'Strongly Disagree',data:sdVals,backgroundColor:C.purple, borderRadius:3,borderSkipped:false},
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'bottom',labels:{color:'#c8cfe0',font:{size:10}}},
      datalabels:{...STACK_LBL},
      tooltip:{...TT_BASE,callbacks:{
        title:i=>'SEL: '+i[0].label,
        label:ctx=>{const n=['Strongly Agree','Agree','Neutral','Disagree','Strongly Disagree'];return ' '+n[ctx.datasetIndex]+': '+ctx.parsed.y+'%';},
        afterBody:i=>{const d=barDomains[i[0].dataIndex];const r=getRow(curWin,d);return r?['','  âœ… Positive (SA+A): '+(r.sa+r.a)+'%','  Concerns (D+SD): '+(r.d+r.sd)+'%']:[];},
      }}},
    scales:{x:{stacked:true,grid:{color:G},ticks:{color:'#c8cfe0',font:{size:9},maxRotation:35}},
            y:{stacked:true,grid:{color:G},max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // â”€â”€ Line chart: Average positive score across all windows â”€â”€
  const lineWins = windows;
  const avgPositive = lineWins.map(w=>{ const r=getRow(w,'Average'); return r?posScore(r):null; });
  mkChart('selLine',{type:'line',data:{labels:lineWins,datasets:[{
    label:'Positive Responses (SA+A)',
    data:avgPositive,
    borderColor:C.amber,backgroundColor:'rgba(245,158,11,.08)',
    tension:.4,pointRadius:6,borderWidth:2.5,fill:true,
    pointBackgroundColor:C.amber,
  }]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},
      datalabels:{display:true,color:C.amber,font:{family:"'IBM Plex Mono',monospace",size:9,weight:'600'},formatter:v=>v!=null?v+'%':'',anchor:'top',align:'top',offset:4,backgroundColor:'rgba(11,13,19,0.75)',borderRadius:3,padding:{top:2,bottom:2,left:4,right:4}},
      tooltip:{...TT_BASE,callbacks:{
        title:i=>'SEL Average Â· '+i[0].label,
        label:ctx=>' Positive (SA+A): '+ctx.parsed.y+'%',
        afterBody:i=>{
          const w=lineWins[i[0].dataIndex];
          const pw=lineWins[i[0].dataIndex-1];
          if(pw){ const prev=avgPositive[i[0].dataIndex-1]; const cur=avgPositive[i[0].dataIndex]; if(cur!=null&&prev!=null) return['',' Change: '+(cur>=prev?'+':'')+(cur-prev)+' pts']; }
          return [];
        },
      }}},
    scales:{x:{grid:{color:G},ticks:{color:'#c8cfe0',font:{size:9}}},
            y:{grid:{color:G},min:50,max:100,ticks:{color:'#c8cfe0',callback:v=>v+'%'}}}}});

  // â”€â”€ Table â”€â”€
  const tbody = document.getElementById('selTblBody'); if(!tbody) return;
  tbody.innerHTML = '';
  [...domains,'Average'].forEach(d=>{
    const r = getRow(curWin,d); if(!r) return;
    const pos = r.sa+r.a;
    const neg = r.d+r.sd;
    const prevR = prevWin?getRow(prevWin,d):null;
    const prevPos = prevR?posScore(prevR):null;
    const chg = prevPos!=null?(pos-prevPos).toFixed(1):null;
    const isBold = d==='Average';
    tbody.innerHTML += `<tr style="${isBold?'font-weight:700;border-top:1px solid var(--b2)':''}">
      <td class="dn" style="${isBold?'color:var(--amber)':''}">${d}</td>
      <td><span class="dp pg">${r.sa}%</span></td>
      <td class="dm">${r.a}%</td>
      <td><strong class="dm" style="color:${pos>=65?'var(--green)':pos>=55?'var(--amber)':'var(--rose)'}">${pos}%</strong></td>
      <td class="dm">${r.n}%</td>
      <td class="dm">${r.d}%</td>
      <td><span class="dp ${neg<=5?'pg':neg<=10?'pa':'pr'}">${r.sd}%</span></td>
      ${prevWin?`<td><span class="dp ${chg==null?'pb':parseFloat(chg)>=0?'pg':'pr'}">${chg==null?'â€”':(parseFloat(chg)>=0?'+':'')+chg+'pts'}</span></td>`:''}
    </tr>`;
  });
}

// â•â• WINDOW FILTER BUTTONS â•â•
function setWinFilter(type, win, btn){
  if(type==='acad') acadWinFilter=win;
  else if(type==='read') readWinFilter=win;
  else if(type==='math') mathWinFilter=win;
  btn.closest('.win-filter-strip').querySelectorAll('.wfb').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const grpBtn = document.querySelector('#'+type+'Filter .fb.active');
  const grp = grpBtn ? grpBtn.textContent.trim()==='Hispanic'?'Hispanics':grpBtn.textContent.trim() : 'All Students';
  if(type==='acad') renderAcad(grp);
  else if(type==='read') renderRead(grp);
  else if(type==='math') renderMath(grp);
}

// â•â• SUBGROUP FILTER â•â•
function setGroup(type,grp,btn){
  btn.closest('.filter-strip').querySelectorAll('.fb').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(type==='acad') renderAcad(grp);
  else if(type==='read') renderRead(grp);
  else if(type==='math') renderMath(grp);
}

function navTo(id, btn){
  const el = document.getElementById(id);
  if(!el) return;
  // Offset for sticky nav height (54px)
  const top = el.getBoundingClientRect().top + window.scrollY - 58;
  window.scrollTo({top, behavior:'smooth'});
  if(btn){
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    btn.classList.add('active');
  }
}

// â”€â”€ Scroll-spy: highlight nav item as sections scroll into view â”€â”€
function initScrollSpy(){
  const sectionIds = ['cep','cep-progress','p1','p2','p3','p4','p5','ca-section'];
  const navBtns    = document.querySelectorAll('.nav-link[data-section]');

  // Map section â†’ button
  const btnMap = {};
  navBtns.forEach(b => { btnMap[b.dataset.section] = b; }); btnMap['cep'] = btnMap['cep'] || document.querySelector('[data-section="cep"]');

  const observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        const id = entry.target.id;
        // Activate matching nav button
        navBtns.forEach(b=>b.classList.remove('active'));
        if(btnMap[id]) btnMap[id].classList.add('active');
        // Scroll nav so active item is visible (for mobile)
        if(btnMap[id]){
          btnMap[id].scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
        }
      }
    });
  },{
    rootMargin:'-58px 0px -55% 0px', // trigger when section top enters top 45% of viewport
    threshold: 0
  });

  sectionIds.forEach(id=>{
    const el = document.getElementById(id);
    if(el) observer.observe(el);
  });
  // Also observe the cep-progress div (it's inside the cep section)
  const cpEl = document.getElementById('cep-progress');
  if(cpEl) observer.observe(cpEl);
}
function hardRefresh(){ location.reload(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  ldProgress(5,'Connecting to Google Sheetsâ€¦');
  try {
    ldStep('ls-acad','active'); ldProgress(10,'Loading Acadience dataâ€¦');
    ACAD = parseAcad(await fetchCSV(URLS.acad,'Acadience'));
    ldStep('ls-acad','done'); ldProgress(25,'Acadience âœ“');

    ldStep('ls-read','active'); ldProgress(30,'Loading iReady Readingâ€¦');
    READ = parseIReady(await fetchCSV(URLS.read,'iReady Reading'));
    ldStep('ls-read','done'); ldProgress(45,'iReady Reading âœ“');

    ldStep('ls-math','active'); ldProgress(50,'Loading iReady Mathâ€¦');
    MATH = parseIReady(await fetchCSV(URLS.math,'iReady Math'));
    ldStep('ls-math','done'); ldProgress(65,'iReady Math âœ“');

    ldStep('ls-ca','active'); ldProgress(70,'Loading Absenteeism dataâ€¦');
    CA_DATA = parseCA(await fetchCSV(URLS.ca,'Chronic Absenteeism'));
    ldStep('ls-ca','done'); ldProgress(85,'Absenteeism âœ“');

    ldStep('ls-sel','active'); ldProgress(90,'Checking SEL tabâ€¦');
    try {
      SEL_ROWS = await fetchCSV(URLS.sel,'SEL');
      console.log('SEL rows loaded:', SEL_ROWS.length, SEL_ROWS[0]);
    } catch(e){ SEL_ROWS=[]; console.warn('SEL fetch failed:', e); }
    ldStep('ls-sel','done'); ldProgress(98,'Almost readyâ€¦');

    updateHeroKPIs();
    renderAcad('All Students'); buildInsights('acadInsights',ACAD,'acad');
    renderRead('All Students'); buildInsights('readInsights',READ,'read');
    renderMath('All Students'); buildInsights('mathInsights',MATH,'math');
    renderCA();
    renderSEL();
    renderTargets();

    const now = new Date().toLocaleString();
    document.getElementById('last-updated').textContent = 'Updated: '+now;
    document.getElementById('ft-updated').textContent   = 'Last updated: '+now+' Â· ';
    ldProgress(100,'Ready!');
    setTimeout(()=>{ ldHide(); initScrollSpy(); }, 600);

  } catch(err){
    document.getElementById('ldStatus').textContent = 'âš ï¸ '+err.message;
    console.error(err);
    document.getElementById('app').classList.add('visible');
    document.querySelector('.page').insertAdjacentHTML('afterbegin',
      '<div style="background:rgba(251,113,133,.1);border:1px solid rgba(251,113,133,.4);border-radius:14px;padding:1.25rem 1.5rem;margin:1rem 0;font-family:var(--ff-m);font-size:.8rem;color:#fb7185;line-height:1.7">'+
      'âš ï¸ <strong>Could not load live data.</strong><br>'+
      'Check: File â†’ Share â†’ Publish to the web in your Google Sheet. Each tab must be published as CSV.</div>'
    );
    setTimeout(ldHide, 2500);
  }
}

// â•â• CARD ZOOM MODAL â•â•
function openCardZoom(card){
  const overlay = document.getElementById('cardZoomOverlay');
  const box     = document.getElementById('cardZoomContent');

  // Clone the card content (not the card itself â€” its inner HTML)
  box.innerHTML = card.innerHTML;

  // Scale up text inside the clone
  box.style.fontSize  = '1.1em';
  box.style.lineHeight = '1.6';

  // Make cloned tc-current bigger
  const cur = box.querySelector('.tc-current');
  if(cur){ cur.style.fontSize = '3rem'; cur.style.marginBottom = '1rem'; }

  // Make cloned tc-label bigger and brighter
  const lbl = box.querySelector('.tc-label');
  if(lbl){ lbl.style.fontSize = '.85rem'; lbl.style.color = 'var(--text)'; lbl.style.marginBottom = '1.2rem'; }

  // Scale bar labels
  box.querySelectorAll('[style*=".5rem"]').forEach(el=>{
    el.style.fontSize = '.72rem';
  });

  // Re-animate the progress bar fill
  const fill = box.querySelector('.tc-bar-fill');
  if(fill){
    const targetW = fill.dataset.w;
    fill.style.transition = 'none';
    fill.style.width = '0%';
    setTimeout(()=>{ fill.style.transition = 'width .9s cubic-bezier(.4,0,.2,1)'; fill.style.width = targetW + '%'; }, 60);
  }

  // Show modal
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // ESC key to close
  document.addEventListener('keydown', _zoomEsc);
}

function closeCardZoom(){
  document.getElementById('cardZoomOverlay').style.display = 'none';
  document.body.style.overflow = '';
  document.removeEventListener('keydown', _zoomEsc);
}

function _zoomEsc(e){ if(e.key === 'Escape') closeCardZoom(); }

document.addEventListener('DOMContentLoaded', init);

</script>

<!-- â”€â”€ ZOOM MODAL â”€â”€ -->
<div id="cardZoomOverlay" onclick="closeCardZoom()" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:1.5rem">
  <div id="cardZoomBox" onclick="event.stopPropagation()" style="position:relative;background:var(--card2);border:1px solid var(--b2);border-radius:20px;padding:2.5rem 2.8rem;max-width:480px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,.6)">
    <button onclick="closeCardZoom()" style="position:absolute;top:.9rem;right:.9rem;background:rgba(255,255,255,.08);border:none;color:var(--text2);font-size:1.1rem;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background='rgba(255,255,255,.08)'">âœ•</button>
    <div id="cardZoomContent" style="transform-origin:top left"></div>
    <div style="margin-top:1.5rem;text-align:center;font-family:var(--ff-m);font-size:.6rem;color:var(--text3)">Click anywhere outside to close Â· ESC to dismiss</div>
  </div>
</div>

</body>
</html>
